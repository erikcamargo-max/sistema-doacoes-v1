<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Teste QR Code PIX</title>
    <script>


// ===============================================================================
// FUNÃ‡Ã•ES PIX BR CODE - PADRÃƒO BANCO CENTRAL
// VersÃ£o: 1.2.0
// ===============================================================================

/**
 * ConfiguraÃ§Ãµes PIX da organizaÃ§Ã£o
 */
const PIX_CONFIG = {
    chavePix: '03.689.866/0001-40',
    nomeBeneficiario: 'APAE TRES LAGOAS',
    cidade: 'TRES LAGOAS',
    identificador: 'APAE'
};

/**
 * Gera o payload PIX no padrÃ£o EMV/BR Code
 * @param {number} valor - Valor da doaÃ§Ã£o
 * @param {string} identificador - ID Ãºnico da transaÃ§Ã£o
 * @returns {string} - Payload PIX
 */
function gerarPayloadPix(valor, identificador) {
    const ID_PAYLOAD_FORMAT_INDICATOR = '00';
    const ID_MERCHANT_ACCOUNT_INFORMATION = '26';
    const ID_MERCHANT_CATEGORY_CODE = '52';
    const ID_TRANSACTION_CURRENCY = '53';
    const ID_TRANSACTION_AMOUNT = '54';
    const ID_COUNTRY_CODE = '58';
    const ID_MERCHANT_NAME = '59';
    const ID_MERCHANT_CITY = '60';
    const ID_ADDITIONAL_DATA_FIELD_TEMPLATE = '62';
    const ID_CRC16 = '63';
    
    const ID_MERCHANT_ACCOUNT_INFORMATION_GUI = '00';
    const ID_MERCHANT_ACCOUNT_INFORMATION_KEY = '01';
    const ID_MERCHANT_ACCOUNT_INFORMATION_DESCRIPTION = '02';
    
    const ID_ADDITIONAL_DATA_FIELD_TEMPLATE_TXID = '05';
    
    // Formatar valor (sempre com 2 casas decimais)
    const valorFormatado = valor.toFixed(2);
    
    // Montar o Merchant Account Information
    let merchantAccountInfo = '';
    merchantAccountInfo += ID_MERCHANT_ACCOUNT_INFORMATION_GUI + '14' + 'BR.GOV.BCB.PIX';
    merchantAccountInfo += ID_MERCHANT_ACCOUNT_INFORMATION_KEY + padLeft(PIX_CONFIG.chavePix.length, 2) + PIX_CONFIG.chavePix;
    
    // Montar Additional Data Field
    const txid = (PIX_CONFIG.identificador + identificador).substring(0, 25).toUpperCase();
    let additionalDataField = '';
    additionalDataField += ID_ADDITIONAL_DATA_FIELD_TEMPLATE_TXID + padLeft(txid.length, 2) + txid;
    
    // Montar o payload
    let payload = '';
    payload += ID_PAYLOAD_FORMAT_INDICATOR + '02' + '01';
    payload += ID_MERCHANT_ACCOUNT_INFORMATION + padLeft(merchantAccountInfo.length, 2) + merchantAccountInfo;
    payload += ID_MERCHANT_CATEGORY_CODE + '04' + '0000';
    payload += ID_TRANSACTION_CURRENCY + '03' + '986'; // BRL
    payload += ID_TRANSACTION_AMOUNT + padLeft(valorFormatado.length, 2) + valorFormatado;
    payload += ID_COUNTRY_CODE + '02' + 'BR';
    payload += ID_MERCHANT_NAME + padLeft(PIX_CONFIG.nomeBeneficiario.length, 2) + PIX_CONFIG.nomeBeneficiario;
    payload += ID_MERCHANT_CITY + padLeft(PIX_CONFIG.cidade.length, 2) + PIX_CONFIG.cidade;
    payload += ID_ADDITIONAL_DATA_FIELD_TEMPLATE + padLeft(additionalDataField.length, 2) + additionalDataField;
    payload += ID_CRC16 + '04';
    
    // Calcular e adicionar CRC16
    payload += calcularCRC16(payload);
    
    return payload;
}

/**
 * Calcula o CRC16 do payload PIX
 */
function calcularCRC16(payload) {
    const polinomio = 0x1021;
    let resultado = 0xFFFF;
    
    if (payload.length > 0) {
        for (let offset = 0; offset < payload.length; offset++) {
            resultado ^= (payload.charCodeAt(offset) << 8);
            for (let bitwise = 0; bitwise < 8; bitwise++) {
                if ((resultado <<= 1) & 0x10000) resultado ^= polinomio;
                resultado &= 0xFFFF;
            }
        }
    }
    
    return resultado.toString(16).toUpperCase().padStart(4, '0');
}

/**
 * Adiciona zeros Ã  esquerda
 */
function padLeft(length, size) {
    return String(length).padStart(size, '0');
}

/**
 * Gera QR Code usando API pÃºblica
 * @param {string} payload - Payload PIX
 * @returns {string} - URL da imagem do QR Code
 */
function gerarQRCodeURL(payload) {
    // Usando API pÃºblica do QR Server
    const encoded = encodeURIComponent(payload);
    return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encoded}`;
}

/**
 * Gera o HTML do QR Code PIX para o carnÃª
 */
function gerarHTMLQRCodePix(valor, doacaoId) {
    const payload = gerarPayloadPix(valor, String(doacaoId).padStart(6, '0'));
    const qrCodeURL = gerarQRCodeURL(payload);
    
    return `
        <!-- QR Code PIX Real -->
        <div class="qr-pix" style="background: white; padding: 15px;">
            <img src="${qrCodeURL}" alt="QR Code PIX" style="width: 100%; height: auto;">
            <div class="qr-pix-info" style="margin-top: 10px; font-size: 11px; color: #333;">
                <strong>PIX COPIA E COLA:</strong><br>
                <textarea readonly style="width: 100%; height: 60px; font-size: 9px; resize: none; border: 1px solid #ddd; padding: 5px; margin-top: 5px;">${payload}</textarea>
            </div>
        </div>
    `;
}

// ===============================================================================

    </script>
</head>
<body style="font-family: Arial; padding: 20px;">
    <h1>ðŸ§ª Teste do QR Code PIX</h1>
    
    <div style="border: 2px solid #333; padding: 20px; max-width: 400px;">
        <h2>Dados do PIX:</h2>
        <p><strong>Chave PIX (CNPJ):</strong> 03.689.866/0001-40</p>
        <p><strong>BeneficiÃ¡rio:</strong> APAE TRES LAGOAS</p>
        <p><strong>Cidade:</strong> TRES LAGOAS</p>
        <p><strong>Valor Teste:</strong> R$ 50,00</p>
        
        <h3>QR Code Gerado:</h3>
        <div id="qrcode"></div>
        
        <h3>Payload PIX (Copia e Cola):</h3>
        <textarea id="payload" style="width: 100%; height: 100px; font-family: monospace;"></textarea>
    </div>
    
    <script>
        // Teste
        const valor = 50.00;
        const id = '123456';
        const payload = gerarPayloadPix(valor, id);
        const qrURL = gerarQRCodeURL(payload);
        
        document.getElementById('qrcode').innerHTML = '<img src="' + qrURL + '" style="width: 200px;">';
        document.getElementById('payload').value = payload;
        
        console.log('Payload gerado:', payload);
        console.log('QR Code URL:', qrURL);
    </script>
</body>
</html>