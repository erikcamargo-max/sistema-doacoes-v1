
// ===============================================================================
// SISTEMA DE NOTIFICA√á√ïES - Vers√£o 1.1.5
// Data: 05/09/2025
// ===============================================================================

function showNotification(message, type = 'info', duration = 5000) {
    const notification = document.createElement('div');
    const colors = {
        'info': 'background: #3b82f6; border-left: 4px solid #1d4ed8;',
        'success': 'background: #10b981; border-left: 4px solid #059669;',
        'error': 'background: #ef4444; border-left: 4px solid #dc2626;',
        'warning': 'background: #f59e0b; border-left: 4px solid #d97706;'
    };
    
    const icons = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úÖ',
        'error': '‚ùå',
        'warning': '‚ö†Ô∏è'
    };
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        ${colors[type] || colors.info}
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000;
        max-width: 350px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        font-weight: 500;
        transform: translateX(100%);
        transition: transform 0.3s ease, opacity 0.3s ease;
    `;
    
    notification.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 18px;">${icons[type] || icons.info}</span>
            <span style="flex: 1;">${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" 
                    style="background: none; border: none; color: white; font-size: 18px; cursor: pointer; padding: 0; margin-left: 10px;">
                √ó
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Animar entrada
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    // Auto-remover
    setTimeout(() => {
        if (notification.parentElement) {
            notification.style.transform = 'translateX(100%)';
            notification.style.opacity = '0';
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 300);
        }
    }, duration);
}


// ===============================================================================
// FUN√á√ÉO DE BUSCA DE CEP
// ===============================================================================

// Fun√ß√£o para buscar CEP via ViaCEP




// ===============================================================================
// SISTEMA DE CONTROLE DE DOA√á√ïES - APP.JS CORRIGIDO v1.1.1
// ===============================================================================


// ===============================================================================
// FUN√á√ÉO PARA CAMPOS RECORRENTES - Vers√£o 1.1.2
// ===============================================================================

function toggleRecurringFields() {
    const checkbox = document.getElementById('input-recurrent');
    const fields = document.getElementById('recurring-fields');
    const proximaParcelaField = document.getElementById('input-proxima-parcela');
    
    if (checkbox && fields) {
        if (checkbox.checked) {
            fields.style.display = 'block';
            
            // Calcular pr√≥xima parcela (30 dias √† frente)
            if (proximaParcelaField) {
                const hoje = new Date();
                const proximaData = new Date(hoje);
                proximaData.setDate(proximaData.getDate() + 30);
                
                const dataFormatada = proximaData.toISOString().substring(0, 10);
                proximaParcelaField.value = dataFormatada;
            }
            
            console.log('üîÑ Campos de recorr√™ncia ativados');
        } else {
            fields.style.display = 'none';
            console.log('üîÑ Campos de recorr√™ncia desativados');
        }
    }
}

// Tornar fun√ß√£o global
window.toggleRecurringFields = toggleRecurringFields;


// ===============================================================================
// FUN√á√ïES VIACEP CORRIGIDAS - Vers√£o 1.1.4 DEFINITIVA
// ===============================================================================

// Fun√ß√£o para buscar CEP via ViaCEP API - CORRIGIDA
window.buscarCEP = async function(cepValue, contexto = 'input') {
    console.log('üîç buscarCEP chamada:', { cepValue, contexto });
    
    // Limpar CEP
    const cep = cepValue.replace(/\D/g, '');
    
    if (cep.length !== 8) {
        console.log('‚ö†Ô∏è CEP inv√°lido (n√£o tem 8 d√≠gitos):', cep);
        return;
    }
    
    // Definir IDs dos campos baseado no contexto
    let ids = {};
    if (contexto === 'input') {
        // Modal Nova Doa√ß√£o
        ids = {
            cep: 'input-cep',
            logradouro: 'input-logradouro',
            bairro: 'input-bairro',
            cidade: 'input-cidade',
            estado: 'input-estado'
        };
    } else if (contexto === 'edit') {
        // Modal Edi√ß√£o
        ids = {
            cep: 'edit-cep',
            logradouro: 'edit-logradouro',
            bairro: 'edit-bairro',
            cidade: 'edit-cidade',
            estado: 'edit-estado'
        };
    } else if (contexto === 'simple') {
        // Modal Simples (legado)
        ids = {
            cep: 'simple-cep',
            logradouro: 'simple-logradouro',
            bairro: 'simple-bairro',
            cidade: 'simple-cidade',
            estado: 'simple-estado'
        };
    } else {
        console.error('‚ùå Contexto inv√°lido:', contexto);
        return;
    }
    
    console.log('üéØ IDs que ser√£o usados:', ids);
    
    // Obter elementos
    const cepField = document.getElementById(ids.cep);
    const logradouroField = document.getElementById(ids.logradouro);
    const bairroField = document.getElementById(ids.bairro);
    const cidadeField = document.getElementById(ids.cidade);
    const estadoField = document.getElementById(ids.estado);
    
    console.log('üì± Elementos encontrados:', {
        cep: !!cepField,
        logradouro: !!logradouroField,
        bairro: !!bairroField,
        cidade: !!cidadeField,
        estado: !!estadoField
    });
    
    // Mostrar indicador de carregamento
    if (cepField) {
        cepField.style.borderColor = '#fbbf24'; // Amarelo
        console.log('üü° Indicador de carregamento ativado');
    }
    
    try {
        const url = `https://viacep.com.br/ws/${cep}/json/`;
        console.log('üåê Fazendo requisi√ß√£o para:', url);
        
        const response = await fetch(url);
        const data = await response.json();
        
        console.log('üì¶ Resposta ViaCEP:', data);
        
        if (!data.erro) {
            // Preencher campos automaticamente
            if (logradouroField && data.logradouro) {
                logradouroField.value = data.logradouro;
                console.log('‚úÖ Logradouro preenchido:', data.logradouro);
            }
            if (bairroField && data.bairro) {
                bairroField.value = data.bairro;
                console.log('‚úÖ Bairro preenchido:', data.bairro);
            }
            if (cidadeField && data.localidade) {
                cidadeField.value = data.localidade;
                console.log('‚úÖ Cidade preenchida:', data.localidade);
            }
            if (estadoField && data.uf) {
                estadoField.value = data.uf;
                console.log('‚úÖ Estado preenchido:', data.uf);
            }
            
            // Indicar sucesso
            if (cepField) {
                cepField.style.borderColor = '#10b981'; // Verde
                setTimeout(() => {
                    cepField.style.borderColor = '#d1d5db'; // Volta ao normal
                }, 2000);
                console.log('üü¢ Indicador de sucesso ativado');
            }
            
            // Focar no pr√≥ximo campo (n√∫mero)
            const numeroField = document.getElementById(ids.cep.replace('-cep', '-numero'));
            if (numeroField) {
                setTimeout(() => numeroField.focus(), 100);
                console.log('üéØ Foco movido para campo n√∫mero');
            }
            
        } else {
            console.log('‚ùå CEP n√£o encontrado na base ViaCEP');
            if (cepField) {
                cepField.style.borderColor = '#ef4444'; // Vermelho
                setTimeout(() => {
                    cepField.style.borderColor = '#d1d5db';
                }, 2000);
            }
        }
    } catch (error) {
        console.error('‚ùå Erro ao buscar CEP:', error);
        if (cepField) {
            cepField.style.borderColor = '#ef4444'; // Vermelho
            setTimeout(() => {
                cepField.style.borderColor = '#d1d5db';
            }, 2000);
        }
        
        // Mostrar erro amig√°vel ao usu√°rio
        alert('Erro ao buscar CEP. Verifique sua conex√£o com a internet e tente novamente.');
    }
}

// Fun√ß√£o para formatar input de CEP - CORRIGIDA
window.formatCEPInput = function(event) {
    console.log('‚å®Ô∏è formatCEPInput chamada:', event.target.id);
    
    let value = event.target.value.replace(/\D/g, '');
    
    // Limitar a 8 d√≠gitos
    if (value.length > 8) {
        value = value.substring(0, 8);
    }
    
    // Adicionar h√≠fen
    if (value.length > 5) {
        value = value.substring(0, 5) + '-' + value.substring(5, 8);
    }
    
    event.target.value = value;
    console.log('‚úÖ CEP formatado:', value);
    
    // Buscar CEP automaticamente quando completo (8 d√≠gitos)
    if (value.replace(/\D/g, '').length === 8) {
        // Detectar contexto baseado no ID do campo
        const fieldId = event.target.id;
        let contexto = 'input';
        
        if (fieldId.includes('edit-')) {
            contexto = 'edit';
        } else if (fieldId.includes('simple-')) {
            contexto = 'simple';
        }
        
        console.log('üöÄ CEP completo, iniciando busca autom√°tica...', { contexto });
        buscarCEP(value, contexto);
    }
}

// Tornar fun√ß√µes acess√≠veis globalmente - IMPORTANTE!
window.buscarCEP = window.buscarCEP;
window.formatCEPInput = window.formatCEPInput;

console.log('‚úÖ Fun√ß√µes ViaCEP 1.1.4 carregadas com sucesso');

// Vari√°veis globais - CORRE√á√ÉO: Declara√ß√£o adequada
let allDonations = [];
let allDonors = [];
let currentEditingId = null;
let currentDonationId = null;
let duplicateCheckModal = null; // Array principal de doa√ß√µes
let filteredDonations = []; // Array filtrado
let editingId = null;
let currentHistoryId = null;

// URLs da API
const API_BASE = '/api';

// Estado dos modais
let modalState = {
    donation: false,
    history: false
};

// Elementos DOM
const elements = {
    loading: null,
    summary: null,
    controls: null,
    tableContainer: null,
    emptyState: null,
    modal: null,
    modalHistory: null,
    searchInput: null,
    filterType: null,
    filterRecurring: null,
    donationsTbody: null,
    btnNovaDoacao: null,
    btnExport: null,
    totalArrecadado: null,
    totalDoacoes: null,
    doacoesRecorrentes: null,
    totalPagamentos: null
};

// ===============================================================================
// INICIALIZA√á√ÉO - CORRE√á√ÉO: Ordem correta de inicializa√ß√£o
// ===============================================================================

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Iniciando Sistema de Doa√ß√µes v1.1.1');
    
    // Inicializar elementos DOM
    initializeElements();
    
    // Configurar event listeners
    setupEventListeners();
    
    // Substituir √≠cones do Feather
    feather.replace();
    
    // Carregar dados
    loadDashboard();
    
    console.log('‚úÖ Sistema inicializado com sucesso');
});

// ===============================================================================
// FUN√á√ïES DE INICIALIZA√á√ÉO
// ===============================================================================

/**
 * Inicializa referencias dos elementos DOM
 * Vers√£o: 1.1.1 - Corre√ß√£o de elementos n√£o encontrados
 */
function initializeElements() {
    elements.loading = document.getElementById('loading');
    elements.summary = document.getElementById('summary');
    elements.tableContainer = document.getElementById('table-container');
    elements.emptyState = document.getElementById('empty-state');
    elements.modal = document.getElementById('modal');
    elements.modalHistory = document.getElementById('modal-history');
    elements.searchInput = document.getElementById('search-input');
    elements.filterType = document.getElementById('filter-type');
    elements.filterRecurring = document.getElementById('filter-recurrent');
    elements.donationsTbody = document.getElementById('donations-tbody');
    elements.btnNovaDoacao = document.getElementById('btn-new-donation');
    elements.btnExport = document.getElementById('btn-export');
    elements.totalArrecadado = document.getElementById('total-arrecadado');
    elements.totalDoacoes = document.getElementById('total-doacoes');
    elements.doacoesRecorrentes = document.getElementById('doacoes-recorrentes');
    elements.totalPagamentos = document.getElementById('total-pagamentos');
    
    console.log('üìã Elementos DOM inicializados');
}

/**
 * Configura event listeners do sistema
 * Vers√£o: 1.1.1 - Corre√ß√£o de listeners duplicados
 */
function setupEventListeners() {
    if (elements.btnNovaDoacao) {
        elements.btnNovaDoacao.addEventListener('click', function(e) {
            e.preventDefault();
            openModal();
        
    
    // Event listener para bot√£o Nova Doa√ß√£o - Vers√£o 1.1.2
    const btnNovaDoacao = document.getElementById('btn-nova-doacao') || document.getElementById('btn-new-donation');
    if (btnNovaDoacao) {
        btnNovaDoacao.addEventListener('click', function(e) {
            e.preventDefault();
            openModal();
        
    
    // Event listener para bot√£o Nova Doa√ß√£o - v1.1.3 CORRIGIDO
    const btnNovaDoacao = document.getElementById('btn-new-donation'); // ID correto do HTML
    if (btnNovaDoacao) {
        btnNovaDoacao.addEventListener('click', function(e) {
            e.preventDefault();
            openModal(); // Agora usa modal HTML
        
    
    // Event listeners para campos de endere√ßo - v1.1.4 CORRIGIDOS
    console.log('üîå Configurando event listeners ViaCEP...');
    
    // Campo CEP do modal Nova Doa√ß√£o
    const cepFieldInput = document.getElementById('input-cep');
    if (cepFieldInput) {
        // Remover listeners antigos para evitar duplica√ß√£o
        cepFieldInput.removeEventListener('input', formatCEPInput);
        cepFieldInput.addEventListener('input', formatCEPInput);
        console.log('‚úÖ Event listener configurado: input-cep');
    } else {
        console.log('‚ö†Ô∏è Campo input-cep n√£o encontrado');
    }
    
    // Campo CEP do modal Edi√ß√£o (se existir)
    const cepFieldEdit = document.getElementById('edit-cep');
    if (cepFieldEdit) {
        cepFieldEdit.removeEventListener('input', formatCEPInput);
        cepFieldEdit.addEventListener('input', formatCEPInput);
        console.log('‚úÖ Event listener configurado: edit-cep');
    }
    
    // Teste manual - bot√£o para testar ViaCEP
    console.log('üß™ Para testar ViaCEP manualmente, use:');
    console.log('   window.buscarCEP("01310-100", "input")');
});
        console.log('‚úÖ Event listener Nova Doa√ß√£o configurado (btn-new-donation)');
    } else {
        console.log('‚ö†Ô∏è Bot√£o btn-new-donation n√£o encontrado');
    }
    
    // Event listener para fechar modal
    const btnCloseModal = document.getElementById('btn-close-modal');
    if (btnCloseModal) {
        btnCloseModal.addEventListener('click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('modal');
            if (modal) modal.style.display = 'none';
        });
        console.log('‚úÖ Event listener fechar modal configurado');
    }
    
    // Event listener para cancelar
    const btnCancel = document.getElementById('btn-cancel');
    if (btnCancel) {
        btnCancel.addEventListener('click', function(e) {
            e.preventDefault();
            const modal = document.getElementById('modal');
            if (modal) modal.style.display = 'none';
        });
        console.log('‚úÖ Event listener cancelar configurado');
    }
    
    // Event listeners para campos de endere√ßo - v1.1.3
    const cepField = document.getElementById('input-cep');
    if (cepField) {
        cepField.addEventListener('input', formatCEPInput);
        console.log('‚úÖ Event listener CEP configurado');
    }
});
        console.log('‚úÖ Event listener Nova Doa√ß√£o configurado');
    } else {
        console.log('‚ö†Ô∏è Bot√£o Nova Doa√ß√£o n√£o encontrado');
    }
    
    // Event listeners para campos de endere√ßo - Vers√£o 1.1.2
    const cepField = document.getElementById('input-cep');
    if (cepField) {
        cepField.addEventListener('input', formatCEPInput);
        console.log('‚úÖ Event listener CEP configurado');
    }
});
    
    // Event listeners para campos de endere√ßo - Vers√£o 1.1.1
    const cepField = document.getElementById('input-cep');
    if (cepField) {
        cepField.addEventListener('input', formatCEPInput);
    }
    
    const btnBuscarCep = document.getElementById('btn-buscar-cep');
    if (btnBuscarCep) {
        btnBuscarCep.addEventListener('click', function() {
            const cep = document.getElementById('input-cep').value;
            if (cep) {
                buscarCEP(cep, 'input');
            }
        });
    }
}
    
    if (elements.btnExport) {
        elements.btnExport.addEventListener('click', function(e) {
            e.preventDefault();
            exportData();
        });
    }
    
    if (elements.searchInput) {
        elements.searchInput.addEventListener('input', applyFilters);
    }
    
    if (elements.filterType) {
        elements.filterType.addEventListener('change', applyFilters);
    }
    
    if (elements.filterRecurring) {
        elements.filterRecurring.addEventListener('change', applyFilters);
    }
    
    console.log('üîó Event listeners configurados');
}

// ===============================================================================
// FUN√á√ïES DE CARREGAMENTO DE DADOS
// ===============================================================================

/**
 * Carrega dashboard completo
 * Vers√£o: 1.1.1 - Ordem correta de carregamento
 */
async function loadDashboard() {
    try {
        console.log('üìä Carregando dashboard...');
        
        // Mostrar loading
        if (elements.loading) elements.loading.style.display = 'block';
        if (elements.summary) elements.summary.style.display = 'none';
        
        // Carregar dados em paralelo
        await Promise.all([
            loadSummary(),
            loadDonations()
        ]);
        
        // Esconder loading e mostrar dashboard
        if (elements.loading) elements.loading.style.display = 'none';
        if (elements.summary) elements.summary.style.display = 'grid';
        
        console.log('‚úÖ Dashboard carregado com sucesso');
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar dashboard:', error);
        showError('Erro ao carregar dashboard: ' + error.message);
    }
}

/**
 * Carrega resumo financeiro
 * Vers√£o: 1.1.1 - Tratamento de erro melhorado
 */
async function loadSummary() {
    try {
        const response = await fetch(API_BASE + '/relatorios/resumo');
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        
        const data = await response.json();
        
        // Atualizar cards do resumo
        if (elements.totalArrecadado) {
            elements.totalArrecadado.textContent = 'R$ ' + (data.total_arrecadado || 0).toFixed(2).replace('.', ',');
        }
        if (elements.totalDoacoes) {
            elements.totalDoacoes.textContent = data.total_doacoes || 0;
        }
        if (elements.doacoesRecorrentes) {
            elements.doacoesRecorrentes.textContent = data.doacoes_recorrentes || 0;
        }
        if (elements.totalPagamentos) {
            elements.totalPagamentos.textContent = data.total_pagamentos || 0;
        }
        
        console.log('üí∞ Resumo carregado:', data);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar resumo:', error);
        throw error;
    }
}

/**
 * Carrega lista de doa√ß√µes
 * Vers√£o: 1.1.1 - CORRE√á√ÉO: Vari√°vel allDonations declarada
 */
async function loadDonations() {
    try {
        console.log('üìã Carregando doa√ß√µes...');
        
        const response = await fetch(API_BASE + '/doacoes');
        
        if (!response.ok) {
            throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        
        const data = await response.json();
        
        // CORRE√á√ÉO: Garantir que allDonations seja um array
        allDonations = Array.isArray(data) ? data : [];
        
        console.log(allDonations.length + ' doa√ß√µes carregadas');
        
        // Aplicar filtros e renderizar
        applyFilters();
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar doa√ß√µes:', error);
        
        // Mostrar estado de erro
        showErrorState(error.message);
        throw error;
    }
}

// ===============================================================================
// FUN√á√ïES DE FILTROS E RENDERIZA√á√ÉO
// ===============================================================================

/**
 * Aplica filtros nas doa√ß√µes
 * Vers√£o: 1.1.1 - CORRE√á√ÉO: Fun√ß√£o simplificada
 */
function applyFilters() {
    const searchTerm = elements.searchInput && elements.searchInput.value ? elements.searchInput.value.toLowerCase() : '';
    const filterType = elements.filterType ? elements.filterType.value : '';
    const filterRecurrent = elements.filterRecurring ? elements.filterRecurring.value : '';
    
    filteredDonations = allDonations.filter(donation => {
        // Verificar se os campos existem antes de usar toLowerCase()
        const donorName = (donation.nome_doador || '').toLowerCase();
        const donorCode = (donation.codigo_doador || '').toLowerCase();
        const phone1 = (donation.telefone1 || '').toLowerCase();
        const phone2 = (donation.telefone2 || '').toLowerCase();
        
        // Filtro de busca
        const matchSearch = !searchTerm || 
            donorName.includes(searchTerm) ||
            donorCode.includes(searchTerm) ||
            phone1.includes(searchTerm) ||
            phone2.includes(searchTerm);
        
        // Filtro de tipo
        const matchType = !filterType || donation.tipo === filterType;
        
        // Filtro de recorr√™ncia
        const matchRecurrent = filterRecurrent === '' || 
            donation.recorrente === parseInt(filterRecurrent);
        
        return matchSearch && matchType && matchRecurrent;
    });
    
    console.log('üîç Filtros aplicados: ' + filteredDonations.length + '/' + allDonations.length + ' doa√ß√µes');
    
    // Renderizar tabela
    renderDonationsTable(filteredDonations);
}

/**
 * Renderiza tabela de doa√ß√µes
 * Vers√£o: 1.1.1 - CORRE√á√ÉO: Tratamento de dados nulos
 */
function renderDonationsTable(donations) {
    if (!elements.donationsTbody || !elements.tableContainer || !elements.emptyState) {
        console.error('‚ùå Elementos da tabela n√£o encontrados');
        return;
    }
    
    if (!donations || donations.length === 0) {
        elements.tableContainer.style.display = 'none';
        elements.emptyState.style.display = 'block';
        return;
    }
    
    elements.tableContainer.style.display = 'block';
    elements.emptyState.style.display = 'none';
    
    elements.donationsTbody.innerHTML = donations.map(donation => {
        // Garantir que todos os campos existem com valores padr√£o
        const nome = donation.nome_doador || 'Doador n√£o identificado';
        const codigo = donation.codigo_doador || ('D' + String(donation.doador_id || 0).padStart(3, '0'));
        const valor = (donation.valor || 0).toFixed(2).replace('.', ',');
        const tipo = donation.tipo || 'N/A';
        const data = formatDate(donation.data_doacao || new Date().toISOString());
        const telefone1 = donation.telefone1 || 'N√£o informado';
        const telefone2 = donation.telefone2 || '';
        const recorrente = donation.recorrente ? 'Sim' : 'N√£o';
        
        return '<tr class="hover:bg-gray-50 transition-colors">' +
                '<td class="px-6 py-4">' +
                    '<div class="text-sm">' +
                        '<div class="font-medium text-gray-900">' + nome + '</div>' +
                        '<div class="text-gray-500">' + codigo + '</div>' +
                    '</div>' +
                '</td>' +
                '<td class="px-6 py-4">' +
                    '<div class="text-sm font-semibold text-green-600">' +
                        'R$ ' + valor +
                    '</div>' +
                '</td>' +
                '<td class="px-6 py-4">' +
                    '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ' + getTypeColor(tipo) + '">' +
                        tipo +
                    '</span>' +
                '</td>' +
                '<td class="px-6 py-4 text-sm text-gray-500">' +
                    data +
                '</td>' +
                '<td class="px-6 py-4 text-sm text-gray-500">' +
                    '<div>' + telefone1 + '</div>' +
                    (telefone2 ? '<div class="text-xs">' + telefone2 + '</div>' : '') +
                '</td>' +
                '<td class="px-6 py-4">' +
                    '<span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ' +
                        (donation.recorrente ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800') + '">' +
                        recorrente +
                    '</span>' +
                '</td>' +
                '<td class="px-6 py-4 text-center">' +
                    '<button onclick="showSimpleHistory(' + donation.id + ')" ' +
                        'class="text-indigo-600 hover:text-indigo-900 transition-colors" ' +
                        'title="Ver hist√≥rico">' +
                        '<i data-feather="clock" class="h-4 w-4"></i>' +
                    '</button>' +
                '</td>' +
                '<td class="px-6 py-4 text-sm font-medium">' +
                    '<div class="flex gap-2">' +
                        '<button onclick="editDonation(' + donation.id + ')" ' +
                            'class="text-blue-600 hover:text-blue-900 transition-colors" ' +
                            'title="Editar">' +
                            '<i data-feather="edit" class="h-4 w-4"></i>' +
                        '</button>' +
                        '<button onclick="generateCarne(' + donation.id + ')" ' +
                            'class="text-green-600 hover:text-green-900 transition-colors" ' +
                            'title="Gerar carn√™">' +
                            '<i data-feather="file-text" class="h-4 w-4"></i>' +
                        '</button>' +
                        '<button onclick="deleteDonation(' + donation.id + ')" ' +
                            'class="text-red-600 hover:text-red-900 transition-colors" ' +
                            'title="Excluir">' +
                            '<i data-feather="trash-2" class="h-4 w-4"></i>' +
                        '</button>' +
                    '</div>' +
                '</td>' +
            '</tr>';
    }).join('');
    
    // Re-renderizar √≠cones do Feather
    feather.replace();
    
    console.log('üìã Tabela renderizada com ' + donations.length + ' itens');
}

// ===============================================================================
// FUN√á√ïES DE MODAL E FORMUL√ÅRIOS
// ===============================================================================

/**
 * Abre modal de nova doa√ß√£o
 * Vers√£o: 1.1.1 - Modal simplificado
 */

// Fun√ß√£o para limpar campos do modal - v1.1.3
function clearModalFields() {
    const fields = [
        'input-donor', 'input-cpf', 'input-phone1', 'input-phone2', 'input-contact',
        'input-cep', 'input-logradouro', 'input-numero', 'input-complemento', 
        'input-bairro', 'input-cidade', 'input-estado',
        'input-amount', 'input-type', 'input-date', 'input-observations',
        'input-parcelas', 'input-proxima-parcela'
    ];
    
    fields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            if (field.type === 'checkbox') {
                field.checked = false;
            } else {
                field.value = '';
            }
        }
    });
    
    // Esconder campos de recorr√™ncia
    const recurringFields = document.getElementById('recurring-fields');
    if (recurringFields) {
        recurringFields.style.display = 'none';
    }
    
    console.log('üßπ Campos do modal limpos');
}

function openModal() {
    console.log('üìù Abrindo modal de nova doa√ß√£o - v1.1.3');
    
    // FOR√áAR uso do modal HTML (n√£o createSimpleModal)
    const modal = document.getElementById('modal');
    const modalTitle = document.getElementById('modal-title');
    
    if (modal) {
        // Configurar modal para nova doa√ß√£o
        if (modalTitle) modalTitle.textContent = 'Nova Doa√ß√£o';
        
        // Limpar todos os campos
        clearModalFields();
        
        // Definir data padr√£o como hoje
        const today = new Date().toISOString().split('T')[0];
        const dateField = document.getElementById('input-date');
        if (dateField) dateField.value = today;
        
        // Mostrar modal
        modal.style.display = 'flex';
        
        // Focar no primeiro campo
        const firstInput = document.getElementById('input-donor');
        if (firstInput) {
            setTimeout(() => firstInput.focus(), 100);
        }
        
        console.log('‚úÖ Modal HTML aberto com sucesso');
    } else {
        console.error('‚ùå Modal HTML n√£o encontrado');
        // Fallback: criar modal simples apenas se HTML n√£o existir
        createSimpleModal();
    }
}

/**
 * Cria modal simplificado de doa√ß√£o
 * Vers√£o: 1.1.1 - Vers√£o simplificada e funcional
 */
function createSimpleModal() {
    let existingModal = document.getElementById('simple-modal');
    if (existingModal) {
        existingModal.remove();
    }
    
    const modalHTML = '<div id="simple-modal" style="' +
            'display: flex;' +
            'position: fixed;' +
            'top: 0;' +
            'left: 0;' +
            'width: 100vw;' +
            'height: 100vh;' +
            'background: rgba(0, 0, 0, 0.8);' +
            'z-index: 999999;' +
            'justify-content: center;' +
            'align-items: center;' +
        '">' +
            '<div style="' +
                'background: white;' +
                'padding: 30px;' +
                'border-radius: 10px;' +
                'max-width: 900px;' +
                'width: 90%;' +
                'max-height: 90vh;' +
                'overflow-y: auto;' +
            '">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">' +
                    '<h2 id="simple-title" style="margin: 0; font-size: 24px; font-weight: bold;">Nova Doa√ß√£o</h2>' +
                    '<button onclick="closeSimpleModal()" style="' +
                        'background: none;' +
                        'border: none;' +
                        'font-size: 30px;' +
                        'cursor: pointer;' +
                        'color: #666;' +
                    '">&times;</button>' +
                '</div>' +
                
                '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">' +
                    '<div>' +
                        '<h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">' +
                            'üë§ Dados do Doador' +
                        '</h3>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome Completo *</label>' +
                            '<input type="text" id="simple-donor" placeholder="Digite o nome completo" style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                            '">' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">CPF</label>' +
                            '<input type="text" id="simple-cpf" placeholder="000.000.000-00" maxlength="14" ' +
                                   'oninput="formatCPFInput(event)" style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                            '">' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone Principal *</label>' +
                            '<input type="tel" id="simple-phone1" placeholder="(11) 99999-9999" style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                            '">' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone Alternativo</label>' +
                            '<input type="tel" id="simple-phone2" placeholder="(11) 88888-8888" style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                            '">' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">E-mail</label>' +
                            '<input type="email" id="simple-email" placeholder="email@exemplo.com" style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                            '">' +
                        '</div>' +
                    '</div>' +
                    
                    '<div>' +
                        '<h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">' +
                            'üí∞ Dados da Doa√ß√£o' +
                        '</h3>' +
                        
                        '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
                            '<div>' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Valor (R$) *</label>' +
                                '<input type="number" id="simple-amount" step="0.01" placeholder="0.00" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<div>' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Tipo *</label>' +
                                '<select id="simple-type" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;' +
                                '">' +
                                    '<option value="Dinheiro">Dinheiro</option>' +
                                    '<option value="PIX">PIX</option>' +
                                '</select>' +
                            '</div>' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Data da Doa√ß√£o *</label>' +
                            '<input type="date" id="simple-date" style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                            '">' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 15px;">' +
                            '<label style="display: flex; align-items: center; gap: 10px; font-weight: bold;">' +
                                '<input type="checkbox" id="simple-recurring" style="' +
                                    'width: 18px; height: 18px; cursor: pointer;' +
                                '">' +
                                '<span>Doa√ß√£o recorrente</span>' +
                            '</label>' +
                        '</div>' +
                        
                        '<div style="margin-bottom: 20px;">' +
                            '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Observa√ß√µes</label>' +
                            '<textarea id="simple-notes" rows="4" placeholder="Informa√ß√µes adicionais sobre a doa√ß√£o..." style="' +
                                'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;' +
                            '"></textarea>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                
                '<div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee;">' +
                    '<button onclick="closeSimpleModal()" style="' +
                        'padding: 12px 25px; border: 2px solid #ccc; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;' +
                    '">Cancelar</button>' +
                    
                    '<button onclick="saveSimpleDonation()" style="' +
                        'padding: 12px 25px; border: none; background: #3b82f6; color: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;' +
                    '">üíæ Salvar Doa√ß√£o</button>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Definir data atual
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('simple-date').value = today;
    
    // Focar no primeiro campo
    document.getElementById('simple-donor').focus();
    
    console.log('‚úÖ Modal criado e exibido');
}

// ===============================================================================
// FUN√á√ïES GLOBAIS EXPOSTAS
// ===============================================================================

/**
 * Fecha modal simples
 * Vers√£o: 1.1.1
 */
window.closeSimpleModal = function() {
    const modal = document.getElementById('simple-modal');
    if (modal) {
        modal.remove();
        console.log('‚ùå Modal fechado');
    }
}

/**
 * Salva doa√ß√£o do modal simples
 * Vers√£o: 1.1.1
 */
window.saveSimpleDonation = async function() {
    console.log('üíæ Salvando doa√ß√£o...');
    
    const formData = {
        donor: document.getElementById('simple-donor').value.trim(),
        amount: parseFloat(document.getElementById('simple-amount').value),
        type: document.getElementById('simple-type').value,
        date: document.getElementById('simple-date').value,
        phone1: document.getElementById('simple-phone1').value.trim(),
        phone2: document.getElementById('simple-phone2').value.trim(),
        contact: document.getElementById('simple-email').value.trim(),
        recurring: document.getElementById('simple-recurring').checked,
        notes: document.getElementById('simple-notes').value.trim(),
        cpf: document.getElementById('simple-cpf').value.trim()
    };
    
    // Valida√ß√£o b√°sica
    if (!formData.donor || !formData.amount || !formData.date || !formData.phone1) {
        alert('‚ùå Preencha todos os campos obrigat√≥rios');
        return;
    }
    
    try {
        const response = await fetch(API_BASE + '/doacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Doa√ß√£o criada com sucesso!');
            closeSimpleModal();
            loadDashboard(); // Recarregar dashboard completo
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Erro: ' + error.message);
    }
}

/**
 * Visualizar hist√≥rico de pagamentos
 * Vers√£o: 1.1.1
 */
window.viewHistory = async function(id) {
    console.log('üìã Carregando hist√≥rico da doa√ß√£o ' + id);
    
    try {
        // Buscar doa√ß√£o
        const donationResponse = await fetch(API_BASE + '/doacoes/' + id);
        const donation = await donationResponse.json();
        
        if (!donationResponse.ok) {
            throw new Error('Doa√ß√£o n√£o encontrada');
        }
        
        // Buscar hist√≥rico
        const historyResponse = await fetch(API_BASE + '/doacoes/' + id + '/historico');
        const payments = await historyResponse.json();
        
        showHistoryModal(donation, payments);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar hist√≥rico:', error);
        alert('‚ùå Erro ao carregar hist√≥rico: ' + error.message);
    }
}

/**
 * Mostra modal de hist√≥rico
 * Vers√£o: 1.1.1
 */
function showHistoryModal(donation, payments) {
    let existingModal = document.getElementById('history-modal-simple');
    if (existingModal) {
        existingModal.remove();
    }
    
    const totalPago = payments.reduce(function(sum, p) { return sum + (p.valor || 0); }, 0);
    
    const modalHTML = '<div id="history-modal-simple" style="' +
            'display: flex;' +
            'position: fixed;' +
            'top: 0;' +
            'left: 0;' +
            'width: 100vw;' +
            'height: 100vh;' +
            'background: rgba(0, 0, 0, 0.8);' +
            'z-index: 999999;' +
            'justify-content: center;' +
            'align-items: center;' +
        '">' +
            '<div style="' +
                'background: white;' +
                'padding: 30px;' +
                'border-radius: 10px;' +
                'max-width: 800px;' +
                'width: 90%;' +
                'max-height: 80vh;' +
                'overflow-y: auto;' +
            '">' +
                '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">' +
                    '<h2 style="margin: 0; font-size: 24px; font-weight: bold;">' +
                        'üìã Hist√≥rico de Pagamentos' +
                    '</h2>' +
                    '<button onclick="closeHistoryModal()" style="' +
                        'background: none;' +
                        'border: none;' +
                        'font-size: 30px;' +
                        'cursor: pointer;' +
                        'color: #666;' +
                    '">&times;</button>' +
                '</div>' +
                
                '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">' +
                    '<div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">' +
                        '<div>' +
                            '<p style="margin: 0; color: #666; font-size: 14px;">Doador</p>' +
                            '<p style="margin: 5px 0 0 0; font-weight: bold; font-size: 18px;">' +
                                (donation.codigo_doador || 'D' + donation.doador_id) + ' - ' + (donation.nome_doador || donation.doador_nome) +
                            '</p>' +
                        '</div>' +
                        '<div>' +
                            '<p style="margin: 0; color: #666; font-size: 14px;">Valor da Doa√ß√£o</p>' +
                            '<p style="margin: 5px 0 0 0; font-weight: bold; font-size: 18px; color: #3b82f6;">' +
                                'R$ ' + (donation.valor || 0).toFixed(2).replace('.', ',') +
                            '</p>' +
                        '</div>' +
                        '<div>' +
                            '<p style="margin: 0; color: #666; font-size: 14px;">Total Pago</p>' +
                            '<p style="margin: 5px 0 0 0; font-weight: bold; font-size: 18px; color: #10b981;">' +
                                'R$ ' + totalPago.toFixed(2).replace('.', ',') +
                            '</p>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                
                '<h3 style="margin: 20px 0 15px 0; font-size: 18px; font-weight: bold;">' +
                    'üí≥ Pagamentos Realizados (' + payments.length + ')' +
                '</h3>' +
                
                (payments.length > 0 ? 
                '<div style="border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">' +
                    '<table style="width: 100%; border-collapse: collapse;">' +
                        '<thead style="background: #f3f4f6;">' +
                            '<tr>' +
                                '<th style="padding: 12px; text-align: left; font-weight: bold; color: #374151;">Data</th>' +
                                '<th style="padding: 12px; text-align: left; font-weight: bold; color: #374151;">Valor</th>' +
                                '<th style="padding: 12px; text-align: left; font-weight: bold; color: #374151;">Status</th>' +
                            '</tr>' +
                        '</thead>' +
                        '<tbody>' +
                            payments.map(function(p) {
                                return '<tr style="border-top: 1px solid #e5e7eb;">' +
                                    '<td style="padding: 12px;">' +
                                        formatDate(p.data_pagamento) +
                                    '</td>' +
                                    '<td style="padding: 12px; font-weight: bold; color: #059669;">' +
                                        'R$ ' + (p.valor || 0).toFixed(2).replace('.', ',') +
                                    '</td>' +
                                    '<td style="padding: 12px;">' +
                                        '<span style="' +
                                            'padding: 4px 12px;' +
                                            'border-radius: 9999px;' +
                                            'font-size: 12px;' +
                                            'font-weight: bold;' +
                                            'background: #10b981;' +
                                            'color: white;' +
                                        '">' + (p.status || 'Pago') + '</span>' +
                                    '</td>' +
                                '</tr>';
                            }).join('') +
                        '</tbody>' +
                    '</table>' +
                '</div>'
                : 
                '<div style="text-align: center; padding: 40px; background: #f9fafb; border-radius: 8px;">' +
                    '<p style="color: #6b7280; margin: 0;">Nenhum pagamento registrado ainda</p>' +
                '</div>'
                ) +
                
                '<div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee;">' +
                    '<button onclick="closeHistoryModal()" style="' +
                        'padding: 12px 25px; border: 2px solid #ccc; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;' +
                    '">Fechar</button>' +
                '</div>' +
            '</div>' +
        '</div>';
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

/**
 * Fecha modal de hist√≥rico
 * Vers√£o: 1.1.1
 */
window.closeHistoryModal = function() {
    const modal = document.getElementById('history-modal-simple');
    if (modal) {
        modal.remove();
        console.log('‚ùå Modal de hist√≥rico fechado');
    }
}

/**
 * Editar doa√ß√£o
 * Vers√£o: 1.1.1
 */
// Fun√ß√£o editDonation ser√° substitu√≠da

/**
 * Gerar carn√™
 * Vers√£o: 1.1.1
 */
// Fun√ß√£o generateCarne ser√° substitu√≠da

/**
 * Deletar doa√ß√£o
 * Vers√£o: 1.1.1
 */
window.deleteDonation = async function(id) {
    if (!confirm('Tem certeza que deseja excluir esta doa√ß√£o?')) {
        return;
    }
    
    try {
        const response = await fetch(API_BASE + '/doacoes/' + id, { 
            method: 'DELETE' 
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Doa√ß√£o exclu√≠da!');
            loadDashboard(); // Recarregar dashboard
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Erro: ' + error.message);
    }
}

/**
 * Exportar dados
 * Vers√£o: 1.1.1
 */
// Fun√ß√£o exportData ser√° substitu√≠da

// ===============================================================================
// FUN√á√ïES UTILIT√ÅRIAS
// ===============================================================================

/**
 * Formatar data para exibi√ß√£o
 * Vers√£o: 1.1.1
 */
function formatDate(dateString) {
    if (!dateString) return 'Data n√£o informada';
    
    try {
        const date = new Date(dateString + 'T00:00:00');
        if (isNaN(date.getTime())) {
            return dateString;
        }
        
        return date.toLocaleDateString('pt-BR');
    } catch (error) {
        return dateString;
    }
}

/**
 * Obter cor do tipo de doa√ß√£o
 * Vers√£o: 1.1.1
 */
function getTypeColor(type) {
    const colors = {
        'Dinheiro': 'bg-green-100 text-green-800',
        'PIX': 'bg-blue-100 text-blue-800',
        'Produto': 'bg-yellow-100 text-yellow-800',
        'Servi√ßo': 'bg-purple-100 text-purple-800'
    };
    return colors[type] || 'bg-gray-100 text-gray-800';
}

/**
 * Formatar entrada de CPF
 * Vers√£o: 1.1.1
 */
function formatCPFInput(event) {
    let value = event.target.value.replace(/\D/g, '');
    if (value.length <= 11) {
        if (value.length <= 3) {
            value = value.replace(/(\d{3})/, '$1');
        } else if (value.length <= 6) {
            value = value.replace(/(\d{3})(\d{3})/, '$1.$2');
        } else if (value.length <= 9) {
            value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1.$2.$3');
        } else {
            value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
    }
    event.target.value = value;
}

/**
 * Mostrar estado de erro
 * Vers√£o: 1.1.1
 */
function showErrorState(message) {
    if (elements.tableContainer) elements.tableContainer.style.display = 'none';
    if (elements.emptyState) {
        elements.emptyState.style.display = 'block';
        elements.emptyState.innerHTML = '<i data-feather="alert-circle" class="mx-auto h-12 w-12 text-red-400"></i>' +
            '<h3 class="mt-2 text-sm font-medium text-gray-900">Erro ao carregar dados</h3>' +
            '<p class="mt-1 text-sm text-gray-500">' + message + '</p>' +
            '<button onclick="loadDashboard()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">' +
                'Tentar Novamente' +
            '</button>';
        feather.replace();
    }
}

/**
 * Mostrar notifica√ß√£o de erro
 * Vers√£o: 1.1.1
 */
function showError(message) {
    const notification = document.createElement('div');
    notification.className = 'fixed top-4 right-4 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(function() {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
    
    console.error('‚ùå ERRO:', message);
}

// ===============================================================================
// FUN√á√ïES GLOBAIS EXPOSTAS - Compatibilidade
// ===============================================================================
window.formatCPFInput = formatCPFInput;
window.loadDashboard = loadDashboard;

console.log('üéØ Sistema de Doa√ß√µes v1.1.1 - Arquivo app.js carregado com sucesso');


// ===============================================================================
// FUN√á√ÉO DE EDI√á√ÉO DE DOA√á√ÉO - RESTAURADA v1.1.2
// ===============================================================================

/**
 * Editar doa√ß√£o existente
 * Vers√£o: 1.1.2 - Fun√ß√£o completa restaurada
 */
window.editDonation = async function(id) {
    console.log('‚úèÔ∏è Editando doa√ß√£o ' + id);
    
    try {
        // Buscar dados completos da doa√ß√£o
        const response = await fetch(API_BASE + '/doacoes/' + id);
        if (!response.ok) {
            throw new Error('Doa√ß√£o n√£o encontrada');
        }
        
        const donation = await response.json();
        
        // Criar modal de edi√ß√£o
        let existingModal = document.getElementById('edit-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        const modalHTML = '<div id="edit-modal" style="' +
                'display: flex;' +
                'position: fixed;' +
                'top: 0;' +
                'left: 0;' +
                'width: 100vw;' +
                'height: 100vh;' +
                'background: rgba(0, 0, 0, 0.8);' +
                'z-index: 999999;' +
                'justify-content: center;' +
                'align-items: center;' +
            '">' +
                '<div style="' +
                    'background: white;' +
                    'padding: 30px;' +
                    'border-radius: 10px;' +
                    'max-width: 900px;' +
                    'width: 90%;' +
                    'max-height: 90vh;' +
                    'overflow-y: auto;' +
                '">' +
                    '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">' +
                        '<h2 style="margin: 0; font-size: 24px; font-weight: bold;">' +
                            'Editar Doa√ß√£o - ' + (donation.codigo_doador || 'D' + donation.doador_id) +
                        '</h2>' +
                        '<button onclick="closeEditModal()" style="' +
                            'background: none;' +
                            'border: none;' +
                            'font-size: 30px;' +
                            'cursor: pointer;' +
                            'color: #666;' +
                        '">&times;</button>' +
                    '</div>' +
                    
                    '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">' +
                        '<div>' +
                            '<h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">' +
                                'üë§ Dados do Doador' +
                            '</h3>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Nome Completo *</label>' +
                                '<input type="text" id="edit-donor" value="' + (donation.nome_doador || donation.doador_nome) + '" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">CPF</label>' +
                                '<input type="text" id="edit-cpf" value="' + (donation.doador_cpf || '') + '" placeholder="000.000.000-00" maxlength="14" ' +
                                       'oninput="formatCPFInput(event)" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone Principal *</label>' +
                                '<input type="tel" id="edit-phone1" value="' + (donation.doador_telefone1 || donation.telefone1) + '" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Telefone Alternativo</label>' +
                                '<input type="tel" id="edit-phone2" value="' + (donation.doador_telefone2 || donation.telefone2 || '') + '" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">E-mail</label>' +
                                '<input type="email" id="edit-email" value="' + (donation.doador_email || '') + '" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<h4 style="margin: 20px 0 15px 0; font-size: 16px; font-weight: bold; color: #555; border-top: 1px solid #eee; padding-top: 15px;">' +
                                'üìç Endere√ßo' +
                            '</h4>' +
                            
                            '<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">CEP</label>' +
                                    '<input type="text" id="edit-cep" value="' + (donation.doador_cep || '') + '" placeholder="00000-000" maxlength="9" ' +
                                           'oninput="formatCEPInput(event)" style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;' +
                                    '">' +
                                '</div>' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Logradouro</label>' +
                                    '<input type="text" id="edit-logradouro" value="' + (donation.doador_logradouro || '') + '" placeholder="Rua, Avenida..." style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;' +
                                    '">' +
                                '</div>' +
                            '</div>' +
                            
                            '<div style="display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px;">' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">N√∫mero</label>' +
                                    '<input type="text" id="edit-numero" value="' + (donation.doador_numero || '') + '" placeholder="123" style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;' +
                                    '">' +
                                '</div>' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Complemento</label>' +
                                    '<input type="text" id="edit-complemento" value="' + (donation.doador_complemento || '') + '" placeholder="Apto, Bloco, Sala..." style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;' +
                                    '">' +
                                '</div>' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 10px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Bairro</label>' +
                                '<input type="text" id="edit-bairro" value="' + (donation.doador_bairro || '') + '" placeholder="Nome do bairro" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;' +
                                '">' +
                            '</div>' +
                            
                            '<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 10px;">' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Cidade</label>' +
                                    '<input type="text" id="edit-cidade" value="' + (donation.doador_cidade || '') + '" placeholder="Nome da cidade" style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px;' +
                                    '">' +
                                '</div>' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px;">Estado</label>' +
                                    '<input type="text" id="edit-estado" value="' + (donation.doador_estado || '') + '" placeholder="UF" maxlength="2" style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 6px; font-size: 14px; text-transform: uppercase;' +
                                    '">' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        
                        '<div>' +
                            '<h3 style="margin: 0 0 20px 0; font-size: 18px; font-weight: bold; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px;">' +
                                'üí∞ Dados da Doa√ß√£o' +
                            '</h3>' +
                            
                            '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">' +
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Valor (R$) *</label>' +
                                    '<input type="number" id="edit-amount" value="' + donation.valor + '" step="0.01" style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                    '">' +
                                '</div>' +
                                
                                '<div>' +
                                    '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Tipo *</label>' +
                                    '<select id="edit-type" style="' +
                                        'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; background: white;' +
                                    '">' +
                                        '<option value="Dinheiro"' + (donation.tipo === 'Dinheiro' ? ' selected' : '') + '>Dinheiro</option>' +
                                        '<option value="PIX"' + (donation.tipo === 'PIX' ? ' selected' : '') + '>PIX</option>' +
                                    '</select>' +
                                '</div>' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Data da Doa√ß√£o *</label>' +
                                '<input type="date" id="edit-date" value="' + donation.data_doacao + '" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;' +
                                '">' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 15px;">' +
                                '<label style="display: flex; align-items: center; gap: 10px; font-weight: bold;">' +
                                    '<input type="checkbox" id="edit-recurring"' + (donation.recorrente ? ' checked' : '') + ' style="' +
                                        'width: 18px; height: 18px; cursor: pointer;' +
                                    '">' +
                                    '<span>Doa√ß√£o recorrente</span>' +
                                '</label>' +
                            '</div>' +
                            
                            '<div style="margin-bottom: 20px;">' +
                                '<label style="display: block; margin-bottom: 5px; font-weight: bold;">Observa√ß√µes</label>' +
                                '<textarea id="edit-notes" rows="4" style="' +
                                    'width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;' +
                                '">' + (donation.observacoes || '') + '</textarea>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                    
                    '<div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px; padding-top: 20px; border-top: 2px solid #eee;">' +
                        '<button onclick="closeEditModal()" style="' +
                            'padding: 12px 25px; border: 2px solid #ccc; background: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;' +
                        '">Cancelar</button>' +
                        
                        '<button onclick="saveEditedDonation(' + id + ')" style="' +
                            'padding: 12px 25px; border: none; background: #3b82f6; color: white; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold;' +
                        '">üíæ Salvar Altera√ß√µes</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar doa√ß√£o:', error);
        alert('‚ùå Erro ao carregar doa√ß√£o: ' + error.message);
    }
}

/**
 * Fecha modal de edi√ß√£o
 * Vers√£o: 1.1.2
 */
window.closeEditModal = function() {
    const modal = document.getElementById('edit-modal');
    if (modal) {
        modal.remove();
        console.log('‚ùå Modal de edi√ß√£o fechado');
    }
}

/**
 * Salva altera√ß√µes da doa√ß√£o editada
 * Vers√£o: 1.1.2
 */
window.saveEditedDonation = async function(id) {
    const formData = {
        donor: document.getElementById('edit-donor').value.trim(),
        amount: parseFloat(document.getElementById('edit-amount').value),
        type: document.getElementById('edit-type').value,
        date: document.getElementById('edit-date').value,
        phone1: document.getElementById('edit-phone1').value.trim(),
        phone2: document.getElementById('edit-phone2').value.trim(),
        contact: document.getElementById('edit-email').value.trim(),
        recurring: document.getElementById('edit-recurring').checked,
        notes: document.getElementById('edit-notes').value.trim(),
        cpf: document.getElementById('edit-cpf').value.trim(),
        // Campos de endere√ßo
        cep: document.getElementById('edit-cep').value.trim(),
        logradouro: document.getElementById('edit-logradouro').value.trim(),
        numero: document.getElementById('edit-numero').value.trim(),
        complemento: document.getElementById('edit-complemento').value.trim(),
        bairro: document.getElementById('edit-bairro').value.trim(),
        cidade: document.getElementById('edit-cidade').value.trim(),
        estado: document.getElementById('edit-estado').value.trim()
    };
    
    if (!formData.donor || !formData.amount || !formData.date || !formData.phone1) {
        alert('‚ùå Preencha todos os campos obrigat√≥rios');
        return;
    }
    
    try {
        const response = await fetch(API_BASE + '/doacoes/' + id, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            alert('‚úÖ Doa√ß√£o atualizada com sucesso!');
            closeEditModal();
            loadDashboard();
        } else {
            alert('‚ùå Erro: ' + data.error);
        }
    } catch (error) {
        alert('‚ùå Erro: ' + error.message);
    }
}

// ===============================================================================
// FUN√á√ïES AUXILIARES PARA O CARN√ä - v1.1.7
// Recuperadas em 13/09/2025
// ===============================================================================

/**
 * Calcular data de vencimento para parcelas
 * Vers√£o: 1.1.7
 */
function calcularVencimento(dataInicial, mesesAdicionais, recorrente) {
    const data = new Date(dataInicial + 'T00:00:00');
    if (recorrente && mesesAdicionais > 0) {
        data.setMonth(data.getMonth() + mesesAdicionais);
    }
    return data.toISOString().substring(0, 10);
}

/**
 * Buscar pagamento no hist√≥rico por data pr√≥xima
 * Vers√£o: 1.1.7
 */
function buscarPagamentoHistorico(historico, dataVencimento) {
    if (!historico || !Array.isArray(historico)) return null;
    
    const vencimento = new Date(dataVencimento + 'T00:00:00');
    
    for (let i = 0; i < historico.length; i++) {
        const pgto = historico[i];
        const dataPgto = new Date(pgto.data_pagamento + 'T00:00:00');
        const diff = Math.abs((dataPgto - vencimento) / (1000 * 60 * 60 * 24));
        if (diff <= 5) { // Toler√¢ncia de 5 dias
            return pgto;
        }
    }
    return null;
}

/**
 * Formatar data para exibi√ß√£o DD/MM/AAAA
 * Vers√£o: 1.1.7
 */
function formatDate(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString + 'T00:00:00');
    const day = String(date.getDate()).padStart(2, '0');
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const year = date.getFullYear();
    return day + '/' + month + '/' + year;
}

/**
 * Montar endere√ßo completo do doador
 * Vers√£o: 1.1.7
 */
function montarEndereco(doador) {
    const parts = [];
    if (doador.logradouro) parts.push(doador.logradouro);
    if (doador.numero) parts.push(doador.numero);
    if (doador.complemento) parts.push(doador.complemento);
    if (doador.bairro) parts.push(doador.bairro);
    if (doador.cidade) parts.push(doador.cidade);
    if (doador.estado) parts.push(doador.estado);
    if (doador.cep) parts.push('CEP: ' + doador.cep);
    
    return parts.length > 0 ? parts.join(', ') : 'Endere√ßo n√£o informado';
}

/**
 * Formatar CPF para exibi√ß√£o
 * Vers√£o: 1.1.7
 */
function formatCPFDisplay(cpf) {
    if (!cpf) return '';
    cpf = cpf.replace(/\D/g, '');
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

// ===============================================================================


// ===============================================================================
// FUN√á√ÉO DE GERA√á√ÉO DE CARN√ä - RESTAURADA v1.1.2
// ===============================================================================

/**
 * Gerar carn√™ de pagamento com canhoto
 * Vers√£o: 1.1.2 - Fun√ß√£o completa restaurada
 */


// ===============================================================================
// FUN√á√ïES PIX BR CODE - PADR√ÉO BANCO CENTRAL
// Vers√£o: 1.2.0
// ===============================================================================

/**
 * Configura√ß√µes PIX da organiza√ß√£o
 */
const PIX_CONFIG = {
    chavePix: '03.689.866/0001-40',
    nomeBeneficiario: 'APAE TRES LAGOAS',
    cidade: 'TRES LAGOAS',
    identificador: 'APAE'
};

/**
 * Gera o payload PIX no padr√£o EMV/BR Code
 * @param {number} valor - Valor da doa√ß√£o
 * @param {string} identificador - ID √∫nico da transa√ß√£o
 * @returns {string} - Payload PIX
 */
function gerarPayloadPix(valor, identificador) {
    const ID_PAYLOAD_FORMAT_INDICATOR = '00';
    const ID_MERCHANT_ACCOUNT_INFORMATION = '26';
    const ID_MERCHANT_CATEGORY_CODE = '52';
    const ID_TRANSACTION_CURRENCY = '53';
    const ID_TRANSACTION_AMOUNT = '54';
    const ID_COUNTRY_CODE = '58';
    const ID_MERCHANT_NAME = '59';
    const ID_MERCHANT_CITY = '60';
    const ID_ADDITIONAL_DATA_FIELD_TEMPLATE = '62';
    const ID_CRC16 = '63';
    
    const ID_MERCHANT_ACCOUNT_INFORMATION_GUI = '00';
    const ID_MERCHANT_ACCOUNT_INFORMATION_KEY = '01';
    const ID_MERCHANT_ACCOUNT_INFORMATION_DESCRIPTION = '02';
    
    const ID_ADDITIONAL_DATA_FIELD_TEMPLATE_TXID = '05';
    
    // Formatar valor (sempre com 2 casas decimais)
    const valorFormatado = valor.toFixed(2);
    
    // Montar o Merchant Account Information
    let merchantAccountInfo = '';
    merchantAccountInfo += ID_MERCHANT_ACCOUNT_INFORMATION_GUI + '14' + 'BR.GOV.BCB.PIX';
    merchantAccountInfo += ID_MERCHANT_ACCOUNT_INFORMATION_KEY + padLeft(PIX_CONFIG.chavePix.length, 2) + PIX_CONFIG.chavePix;
    
    // Montar Additional Data Field
    const txid = (PIX_CONFIG.identificador + identificador).substring(0, 25).toUpperCase();
    let additionalDataField = '';
    additionalDataField += ID_ADDITIONAL_DATA_FIELD_TEMPLATE_TXID + padLeft(txid.length, 2) + txid;
    
    // Montar o payload
    let payload = '';
    payload += ID_PAYLOAD_FORMAT_INDICATOR + '02' + '01';
    payload += ID_MERCHANT_ACCOUNT_INFORMATION + padLeft(merchantAccountInfo.length, 2) + merchantAccountInfo;
    payload += ID_MERCHANT_CATEGORY_CODE + '04' + '0000';
    payload += ID_TRANSACTION_CURRENCY + '03' + '986'; // BRL
    payload += ID_TRANSACTION_AMOUNT + padLeft(valorFormatado.length, 2) + valorFormatado;
    payload += ID_COUNTRY_CODE + '02' + 'BR';
    payload += ID_MERCHANT_NAME + padLeft(PIX_CONFIG.nomeBeneficiario.length, 2) + PIX_CONFIG.nomeBeneficiario;
    payload += ID_MERCHANT_CITY + padLeft(PIX_CONFIG.cidade.length, 2) + PIX_CONFIG.cidade;
    payload += ID_ADDITIONAL_DATA_FIELD_TEMPLATE + padLeft(additionalDataField.length, 2) + additionalDataField;
    payload += ID_CRC16 + '04';
    
    // Calcular e adicionar CRC16
    payload += calcularCRC16(payload);
    
    return payload;
}

/**
 * Calcula o CRC16 do payload PIX
 */
function calcularCRC16(payload) {
    const polinomio = 0x1021;
    let resultado = 0xFFFF;
    
    if (payload.length > 0) {
        for (let offset = 0; offset < payload.length; offset++) {
            resultado ^= (payload.charCodeAt(offset) << 8);
            for (let bitwise = 0; bitwise < 8; bitwise++) {
                if ((resultado <<= 1) & 0x10000) resultado ^= polinomio;
                resultado &= 0xFFFF;
            }
        }
    }
    
    return resultado.toString(16).toUpperCase().padStart(4, '0');
}

/**
 * Adiciona zeros √† esquerda
 */
function padLeft(length, size) {
    return String(length).padStart(size, '0');
}

/**
 * Gera QR Code usando API p√∫blica
 * @param {string} payload - Payload PIX
 * @returns {string} - URL da imagem do QR Code
 */
function gerarQRCodeURL(payload) {
    // Usando API p√∫blica do QR Server
    const encoded = encodeURIComponent(payload);
    return `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encoded}`;
}

/**
 * Gera o HTML do QR Code PIX para o carn√™
 */
function gerarHTMLQRCodePix(valor, doacaoId) {
    const payload = gerarPayloadPix(valor, String(doacaoId).padStart(6, '0'));
    const qrCodeURL = gerarQRCodeURL(payload);
    
    return `
        <!-- QR Code PIX Real -->
        <div class="qr-pix" style="background: white; padding: 15px;">
            <img src="${qrCodeURL}" alt="QR Code PIX" style="width: 100%; height: auto;">
            <div class="qr-pix-info" style="margin-top: 10px; font-size: 11px; color: #333;">
                <strong>PIX COPIA E COLA:</strong><br>
                <textarea readonly style="width: 100%; height: 60px; font-size: 9px; resize: none; border: 1px solid #ddd; padding: 5px; margin-top: 5px;">${payload}</textarea>
            </div>
        </div>
    `;
}

// ===============================================================================

// ===============================================================================
// FUN√á√ïES PIX REAL - PADR√ÉO BANCO CENTRAL BRASILEIRO
// CNPJ: 03.689.866/0001-40 - APAE TRES LAGOAS
// Vers√£o: 1.2.0 - Data: 13/09/2025
// ===============================================================================

/**
 * Gera c√≥digo PIX no padr√£o EMV BR Code do Banco Central
 */
function gerarCodigoPix(valor, idParcela) {
    // Dados da APAE
    const chavePix = "03689866000140";  // CNPJ sem formata√ß√£o
    const nomeBeneficiario = "APAE TRES LAGOAS";
    const cidade = "TRES LAGOAS";
    
    // IDs do padr√£o EMV
    const ID_PAYLOAD_FORMAT = "00";
    const ID_MERCHANT_ACCOUNT = "26";
    const ID_MERCHANT_CATEGORY = "52";
    const ID_CURRENCY = "53";
    const ID_AMOUNT = "54";
    const ID_COUNTRY = "58";
    const ID_MERCHANT_NAME = "59";
    const ID_MERCHANT_CITY = "60";
    const ID_ADDITIONAL_DATA = "62";
    const ID_CRC16 = "63";
    
    // Formatar valor com 2 casas decimais
    const valorFormatado = valor.toFixed(2);
    
    // Montar Merchant Account Information
    let merchantAccount = "";
    merchantAccount += "0014BR.GOV.BCB.PIX";  // GUI
    merchantAccount += "01" + chavePix.length.toString().padStart(2, '0') + chavePix;  // Chave
    
    // ID da transa√ß√£o
    const txId = "APAE" + String(idParcela).padStart(6, '0');
    let additionalData = "05" + txId.length.toString().padStart(2, '0') + txId;
    
    // Montar payload (sem CRC16)
    let payload = "";
    payload += ID_PAYLOAD_FORMAT + "02" + "01";
    payload += ID_MERCHANT_ACCOUNT + merchantAccount.length.toString().padStart(2, '0') + merchantAccount;
    payload += ID_MERCHANT_CATEGORY + "04" + "0000";
    payload += ID_CURRENCY + "03" + "986";  // BRL
    payload += ID_AMOUNT + valorFormatado.length.toString().padStart(2, '0') + valorFormatado;
    payload += ID_COUNTRY + "02" + "BR";
    payload += ID_MERCHANT_NAME + nomeBeneficiario.length.toString().padStart(2, '0') + nomeBeneficiario;
    payload += ID_MERCHANT_CITY + cidade.length.toString().padStart(2, '0') + cidade;
    payload += ID_ADDITIONAL_DATA + additionalData.length.toString().padStart(2, '0') + additionalData;
    payload += ID_CRC16 + "04";
    
    // Calcular CRC16
    const crc16 = calcularCRC16(payload);
    payload += crc16;
    
    return payload;
}

/**
 * Calcula CRC16 para o PIX (padr√£o CCITT)
 */
function calcularCRC16(str) {
    let crc = 0xFFFF;
    let j, i;
    
    for (i = 0; i < str.length; i++) {
        const c = str.charCodeAt(i);
        crc ^= c << 8;
        
        for (j = 0; j < 8; j++) {
            if (crc & 0x8000) {
                crc = (crc << 1) ^ 0x1021;
            } else {
                crc = crc << 1;
            }
        }
    }
    
    crc = crc & 0xFFFF;
    return crc.toString(16).toUpperCase().padStart(4, '0');
}

// ===============================================================================

window.generateCarne = async function(id) {
    try {
        console.log('üé® Gerando carn√™ profissional para doa√ß√£o ID:', id);
        
        // Buscar dados
        const doacaoResponse = await fetch('/api/doacoes/' + id);
        if (!doacaoResponse.ok) throw new Error('Erro ao buscar doa√ß√£o');
        const doacao = await doacaoResponse.json();
        
        const doadorResponse = await fetch('/api/doadores/' + doacao.doador_id);
        if (!doadorResponse.ok) throw new Error('Erro ao buscar doador');
        const doador = await doadorResponse.json();
        
        const historicoResponse = await fetch('/api/doacoes/' + id + '/historico');
        const historico = await historicoResponse.json();
        
        // Abrir nova janela
        const novaJanela = window.open('', '_blank', 'width=1000,height=800');
        if (!novaJanela) {
            throw new Error('Pop-up bloqueado! Permita pop-ups para gerar o carn√™.');
        }
        
        // Gerar HTML do carn√™ profissional
        const htmlContent = gerarHTMLCarneProfissional(doacao, doador, historico);
        
        // Escrever conte√∫do
        novaJanela.document.write(htmlContent);
        novaJanela.document.close();
        
        console.log('‚úÖ Carn√™ profissional gerado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao gerar carn√™:', error);
        alert('Erro ao gerar carn√™: ' + error.message);
    }
}

// Fun√ß√£o para gerar HTML do carn√™ profissional

// Fun√ß√£o para gerar HTML do carn√™ modelo banc√°rio
function gerarHTMLCarneProfissional(doacao, doador, historico) {
    const agora = new Date();
    const dataGeracao = agora.toLocaleDateString('pt-BR');
    const numeroDocumento = String(doacao.id).padStart(8, '0');
    const codigoDoador = doador.codigo_doador || 'D' + String(doador.id).padStart(3, '0');
    
    // Calcular parcelas
    const totalParcelas = doacao.parcelas_totais || (doacao.recorrente ? 12 : 1);
    const valorParcela = doacao.valor;
    
    // Gerar HTML das parcelas
    let htmlParcelas = '';
    for (let i = 1; i <= totalParcelas; i++) {
        const dataVencimento = calcularVencimento(doacao.data_doacao, i - 1, doacao.recorrente);
        const pagamento = buscarPagamentoHistorico(historico, dataVencimento);
        const isPago = !!pagamento;
        
        // Estilo banc√°rio compacto
        htmlParcelas += `
        <div class="parcela-bancaria" style="page-break-inside: avoid;">
            <table style="width: 100%; border: 2px solid #000; border-collapse: collapse; margin-bottom: 10px;">
                <tr>
                    <!-- Logo e Banco -->
                    <td style="width: 20%; border-right: 1px solid #000; padding: 12px; vertical-align: middle;">
                        <img src="/logo-apae.png" alt="Logo APAE" style="width: 150px; height: 150px; object-fit: contain;">
                        
                    </td>
                    
                    <!-- Recibo do Pagador -->
                    <td style="width: 40%; border-right: 2px dashed #666; padding: 12px;">
                        <div style="font-size: 12px; font-weight: bold; margin-bottom: 8px;">Recibo do Pagador</div>
                        
                        <div style="font-size: 10px; margin-bottom: 5px;">
                            <strong>N¬∫ do Documento</strong><br>
                            ${numeroDocumento}
                        </div>
                        
                        <div style="font-size: 10px; margin-bottom: 5px;">
                            <strong>Vencimento</strong><br>
                            <span style="font-weight: bold; font-size: 12px;">${formatDate(dataVencimento)}</span>
                        </div>
                        
                        <div style="font-size: 10px; margin-bottom: 5px;">
                            <strong>Valor</strong><br>
                            <span style="font-weight: bold; font-size: 14px; color: #000;">R$ ${valorParcela.toFixed(2).replace('.', ',')}</span>
                        </div>
                        
                        <div style="font-size: 10px;">
                            <strong>Valor Cobrado</strong><br>
                            _____________
                        </div>
                        
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ccc;">
                            <div style="font-size: 10px;">
                                <strong>Pagador</strong><br>
                                ${doador.nome.toUpperCase()}<br>
                                ${doador.cpf ? 'CPF: ' + formatCPFDisplay(doador.cpf) : ''}<br>
                                TEL: ${doador.telefone1}
                            </div>
                        </div>
                    </td>
                    
                    <!-- Ficha de Compensa√ß√£o -->
                    <td style="width: 40%; padding: 12px; position: relative;">
                        
                        
                        <!-- QR Code -->
                        <div style="position: absolute; top: 15px; right: 15px; text-align: center; background: white; padding: 8px; border: 2px solid #000; border-radius: 5px;">
                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(gerarCodigoPix(valorParcela, i))}" 
                                 alt="QR Code PIX" 
                                 style="width: 100px; height: 100px; border: 1px solid #000;">
                            <div style="font-size: 10px; font-weight: bold; margin-top: 2px;">
                                Use o aplicativo do seu banco<br>
                                ou institui√ß√£o financeira
                            </div>
                        </div>
                        
                        ${isPago ? `
                        <div style="position: absolute; bottom: 10px; right: 10px; background: #28a745; color: white; padding: 5px 10px; border-radius: 3px; font-size: 10px;">
                            ‚úì PAGO EM ${formatDate(pagamento.data_pagamento)}
                        </div>
                        ` : ''}
                    </td>
                </tr>
            </table>
        </div>
        `;
    }
    
    return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Carn√™ Banc√°rio - ${doador.nome}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, Helvetica, sans-serif;
            background: white;
            padding: 12px;
            color: #000;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #000;
            background: #f9f9f9;
        }
        
        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .header-info {
            font-size: 12px;
            margin-top: 10px;
        }
        
        .header-info span {
            display: inline-block;
            margin: 0 10px;
        }
        
        .parcela-bancaria {
            margin-bottom: 10mm;
        }
        
        .no-print {
            margin: 20px 0;
            text-align: center;
        }
        
        .btn-imprimir {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 30px;
            font-size: 14px;
            cursor: pointer;
            border-radius: 3px;
        }
        
        .btn-imprimir:hover {
            background: #0056b3;
        }
        
        @media print {
            body {
                margin: 0;
                padding: 0;
            }
            
            .no-print {
                display: none;
            }
            
            .parcela-bancaria {
                page-break-inside: avoid;
                margin-bottom: 5mm;
            }
            
            .container {
                max-width: 100%;
            }
            
            .header {
                display: none;
            }
        }
        
        /* Estilo para linha tracejada de corte */
        .linha-corte {
            border-top: 1px dashed #666;
            margin: 5px 0;
            position: relative;
        }
        
        .linha-corte::before {
            content: "‚úÇ";
            position: absolute;
            left: -20px;
            top: -10px;
            font-size: 16px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Cabe√ßalho (n√£o imprime) -->
        <div class="header">
            <h1>CARN√ä DE PAGAMENTO - MODELO BANC√ÅRIO</h1>
            <div class="header-info">
                <span><strong>Contribuinte:</strong> ${doador.nome}</span>
                <span><strong>C√≥digo:</strong> ${codigoDoador}</span>
                <span><strong>Total de Parcelas:</strong> ${totalParcelas}</span>
            </div>
            <div class="header-info">
                <span><strong>Documento:</strong> ${numeroDocumento}</span>
                <span><strong>Gerado em:</strong> ${dataGeracao}</span>
            </div>
        </div>
        
        <!-- Parcelas -->
        ${htmlParcelas}
        
        <!-- Bot√£o de Impress√£o -->
        <div class="no-print">
            <button class="btn-imprimir" onclick="window.print()">
                üñ®Ô∏è IMPRIMIR CARN√ä
            </button>
            <p style="margin-top: 10px; font-size: 12px; color: #666;">
                Configure a impress√£o para formato A4, orienta√ß√£o retrato, sem margens
            </p>
        </div>
    </div>
</body>
</html>`;
}


// Fun√ß√£o para gerar HTML de cada parcela
function gerarHTMLParcela(numero, total, dataVencimento, valor, isPago, pagamento, doador, codigoDoador) {
    const statusClass = isPago ? 'status-pago' : 'status-pendente';
    const statusTexto = isPago ? '‚úÖ PAGO' : '‚è≥ PENDENTE';
    
    return `
    <div class="parcela">
        <div class="parcela-header">
            <div class="parcela-numero">
                Parcela ${String(numero).padStart(2, '0')}/${String(total).padStart(2, '0')}
            </div>
            <div class="parcela-status ${statusClass}">
                ${statusTexto}
            </div>
        </div>
        
        <div class="parcela-body">
            <!-- Canhoto -->
            <div class="canhoto">
                <div class="canhoto-titulo">CANHOTO - CONTROLE</div>
                
                <div class="canhoto-campo">
                    <strong>Contribuinte:</strong>
                    <span class="canhoto-valor">${codigoDoador}</span>
                </div>
                
                <div class="canhoto-campo">
                    <strong>Parcela:</strong>
                    ${numero}/${total}
                </div>
                
                <div class="canhoto-campo">
                    <strong>Valor:</strong>
                    <span class="canhoto-valor">R$ ${valor.toFixed(2).replace('.', ',')}</span>
                </div>
                
                <div class="canhoto-campo">
                    <strong>Vencimento:</strong>
                    ${formatDate(dataVencimento)}
                </div>
                
                ${isPago ? `
                <div class="canhoto-campo">
                    <strong>Pago em:</strong>
                    ${formatDate(pagamento.data_pagamento)}
                </div>
                ` : ''}
            </div>
            
            <!-- Recibo -->
            <div class="recibo">
                <div class="recibo-titulo">RECIBO DE PAGAMENTO</div>
                
                <div class="recibo-grid">
                    <div class="recibo-campo">
                        <strong>Recebemos de:</strong>
                        ${doador.nome}
                    </div>
                    
                    <div class="recibo-campo">
                        <strong>Vencimento:</strong>
                        ${formatDate(dataVencimento)}
                    </div>
                    
                    <div class="recibo-campo">
                        <strong>Telefone:</strong>
                        ${doador.telefone1}
                    </div>
                    
                    <div class="recibo-campo">
                        <strong>Endere√ßo:</strong>
                        ${montarEndereco(doador)}
                    </div>
                </div>
                
                <div class="recibo-valor">
                    R$ ${valor.toFixed(2).replace('.', ',')}
                </div>
                
                ${isPago ? `
                <div style="text-align: center; color: #28a745; font-weight: bold;">
                    ‚úÖ Pagamento confirmado em ${formatDate(pagamento.data_pagamento)}
                </div>
                ` : ''}
                
				<div class="qr-pix" style="background: white; padding: 8px; border-radius: 8px; border: 2px solid #667eea;">
					<img src="https://api.qrserver.com/v1/create-qr-code/?size=130x130&data=\${encodeURIComponent(gerarCodigoPix(valor, numero))}" 
						 alt="QR Code PIX" 
						 style="width: 130px; height: 130px; display: block;">
					<div style="font-size: 10px; text-align: center; margin-top: 5px; color: #333;">
						<strong>PIX CNPJ</strong><br>
						03.689.866/0001-40<br>
						<strong style="color: #667eea;">R$ \${valor.toFixed(2).replace('.', ',')}</strong>
					</div>
				</div>
			
			
            </div>
        </div>
    </div>
    `;
}

// ===============================================================================
// FUN√á√ÉO DE EXPORTA√á√ÉO PDF - RESTAURADA v1.1.2
// ===============================================================================

/**
 * Exportar dados em PDF
 * Vers√£o: 1.1.2 - Fun√ß√£o completa restaurada
 */
window.exportData = async function() {
    try {
        console.log('üì§ Gerando relat√≥rio PDF...');
        
        // Buscar dados do resumo
        const resumoResponse = await fetch(API_BASE + '/relatorios/resumo');
        const resumo = await resumoResponse.json();
        
        // Buscar lista de doa√ß√µes
        const doacoesResponse = await fetch(API_BASE + '/doacoes');
        const doacoes = await doacoesResponse.json();
        
        // Criar janela para PDF
        const printWindow = window.open('', '_blank');
        
        // HTML do relat√≥rio
        const relatorioHTML = '' +
'<!DOCTYPE html>' +
'<html lang="pt-BR">' +
'<head>' +
'    <meta charset="UTF-8">' +
'    <title>Relat√≥rio de Doa√ß√µes - ' + new Date().toLocaleDateString('pt-BR') + '</title>' +
'    <style>' +
'        @media print {' +
'            body { margin: 0; }' +
'            .no-print { display: none !important; }' +
'            .page-break { page-break-after: always; }' +
'        }' +
'        body {' +
'            font-family: Arial, sans-serif;' +
'            margin: 20px;' +
'            color: #333;' +
'            line-height: 1.6;' +
'        }' +
'        .header {' +
'            text-align: center;' +
'            margin-bottom: 30px;' +
'            padding: 20px;' +
'            background: #f5f5f5;' +
'            border: 2px solid #333;' +
'        }' +
'        .header h1 {' +
'            margin: 0;' +
'            color: #333;' +
'        }' +
'        .section {' +
'            margin: 30px 0;' +
'        }' +
'        .section-title {' +
'            font-size: 18px;' +
'            font-weight: bold;' +
'            margin-bottom: 15px;' +
'            padding-bottom: 5px;' +
'            border-bottom: 2px solid #333;' +
'        }' +
'        .summary-grid {' +
'            display: grid;' +
'            grid-template-columns: repeat(2, 1fr);' +
'            gap: 20px;' +
'            margin: 20px 0;' +
'        }' +
'        .summary-card {' +
'            padding: 15px;' +
'            background: #f9f9f9;' +
'            border: 1px solid #ddd;' +
'            border-radius: 5px;' +
'        }' +
'        .summary-card h3 {' +
'            margin: 0 0 10px 0;' +
'            color: #555;' +
'            font-size: 14px;' +
'        }' +
'        .summary-card .value {' +
'            font-size: 24px;' +
'            font-weight: bold;' +
'            color: #333;' +
'        }' +
'        table {' +
'            width: 100%;' +
'            border-collapse: collapse;' +
'            margin: 20px 0;' +
'        }' +
'        th {' +
'            background: #333;' +
'            color: white;' +
'            padding: 12px;' +
'            text-align: left;' +
'            font-size: 14px;' +
'        }' +
'        td {' +
'            padding: 8px;' +
'            border-bottom: 1px solid #ddd;' +
'            font-size: 13px;' +
'        }' +
'        tr:nth-child(even) {' +
'            background: #f9f9f9;' +
'        }' +
'        .footer {' +
'            margin-top: 50px;' +
'            padding-top: 20px;' +
'            border-top: 1px solid #ddd;' +
'            text-align: center;' +
'            font-size: 12px;' +
'            color: #666;' +
'        }' +
'        @page {' +
'            size: A4;' +
'            margin: 15mm;' +
'        }' +
'    </style>' +
'</head>' +
'<body>' +
'    <div class="header">' +
'        <h1>RELAT√ìRIO DE DOA√á√ïES</h1>' +
'        <p>Gerado em ' + new Date().toLocaleDateString('pt-BR') + ' √†s ' + new Date().toLocaleTimeString('pt-BR') + '</p>' +
'    </div>' +
'    ' +
'    <div class="section">' +
'        <div class="section-title">RESUMO GERAL</div>' +
'        <div class="summary-grid">' +
'            <div class="summary-card">' +
'                <h3>Total Arrecadado</h3>' +
'                <div class="value">R$ ' + (resumo.total_arrecadado || 0).toFixed(2).replace('.', ',') + '</div>' +
'            </div>' +
'            <div class="summary-card">' +
'                <h3>Total de Doa√ß√µes</h3>' +
'                <div class="value">' + (resumo.total_doacoes || 0) + '</div>' +
'            </div>' +
'            <div class="summary-card">' +
'                <h3>Doa√ß√µes Recorrentes</h3>' +
'                <div class="value">' + (resumo.doacoes_recorrentes || 0) + '</div>' +
'            </div>' +
'            <div class="summary-card">' +
'                <h3>Total de Pagamentos</h3>' +
'                <div class="value">' + (resumo.total_pagamentos || 0) + '</div>' +
'            </div>' +
'        </div>' +
'    </div>' +
'    ' +
'    <div class="section">' +
'        <div class="section-title">DETALHAMENTO DAS DOA√á√ïES</div>' +
'        <table>' +
'            <thead>' +
'                <tr>' +
'                    <th>C√≥digo</th>' +
'                    <th>Doador</th>' +
'                    <th>Valor</th>' +
'                    <th>Tipo</th>' +
'                    <th>Data</th>' +
'                    <th>Recorrente</th>' +
'                    <th>Telefone</th>' +
'                </tr>' +
'            </thead>' +
'            <tbody>';
        
        // Adicionar linhas da tabela
        let tabelaRows = '';
        doacoes.forEach(function(doacao) {
            tabelaRows += '' +
'                <tr>' +
'                    <td>' + (doacao.codigo_doador || 'D' + String(doacao.doador_id).padStart(3, '0')) + '</td>' +
'                    <td>' + (doacao.nome_doador || 'N/A') + '</td>' +
'                    <td>R$ ' + doacao.valor.toFixed(2).replace('.', ',') + '</td>' +
'                    <td>' + doacao.tipo + '</td>' +
'                    <td>' + formatDate(doacao.data_doacao) + '</td>' +
'                    <td>' + (doacao.recorrente ? 'Sim' : 'N√£o') + '</td>' +
'                    <td>' + (doacao.telefone1 || 'N/A') + '</td>' +
'                </tr>';
        });
        
        const finalHTML = relatorioHTML + tabelaRows + '' +
'            </tbody>' +
'        </table>' +
'    </div>' +
'    ' +
'    <div class="footer">' +
'        <p>Sistema de Controle de Doa√ß√µes - Relat√≥rio Oficial</p>' +
'        <p>Este documento foi gerado automaticamente e cont√©m informa√ß√µes confidenciais.</p>' +
'    </div>' +
'    ' +
'    <div class="no-print" style="text-align: center; margin: 30px;">' +
'        <button onclick="window.print()" style="padding: 10px 30px; font-size: 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">' +
'            Imprimir Relat√≥rio' +
'        </button>' +
'    </div>' +
'</body>' +
'</html>';
        
        // Escrever HTML na nova janela
        printWindow.document.write(finalHTML);
        printWindow.document.close();
        
        alert('‚úÖ Relat√≥rio PDF gerado com sucesso!');
        
    } catch (error) {
        console.error('‚ùå Erro ao exportar dados:', error);
        alert('‚ùå Erro ao gerar relat√≥rio PDF: ' + error.message);
    }
}

// ===============================================================================
// FUN√á√ïES AUXILIARES PARA CARN√ä E RELAT√ìRIOS - RESTAURADAS v1.1.2

// ===============================================================================
// GERA√á√ÉO DE CARN√ä PROFISSIONAL - Vers√£o 1.1.5 FINAL
// Data: 05/09/2025
// ===============================================================================



function criarHTMLCarne(doacao, doador, historico) {
    const agora = new Date();
    const dataGeracao = agora.toLocaleDateString('pt-BR') + ' √†s ' + agora.toLocaleTimeString('pt-BR');
    const numeroDocumento = `CRN-${doacao.id.toString().padStart(6, '0')}`;
    
    return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Carn√™ - ${doador.nome}</title>
    <style>
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 20px;
            color: #333;
            line-height: 1.6;
            background: #f8f9fa;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0 0 10px 0;
            font-size: 32px;
        }
        .content {
            padding: 40px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        .info-card {
            background: #f8fafc;
            padding: 25px;
            border-radius: 12px;
            border-left: 5px solid #3b82f6;
        }
        .info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #374151;
        }
        .info-item {
            margin: 10px 0;
            font-size: 14px;
        }
        .info-label {
            font-weight: bold;
            display: inline-block;
            min-width: 100px;
        }
        .valor-destaque {
            text-align: center;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 25px;
            border-radius: 12px;
            margin: 30px 0;
        }
        .valor-destaque .valor {
            font-size: 32px;
            font-weight: bold;
        }
        .qr-section {
            text-align: center;
            background: #f0f9ff;
            padding: 25px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px dashed #3b82f6;
        }
        .parcelas-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .parcelas-table th {
            background: #374151;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }
        .parcelas-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e5e7eb;
        }
        .parcelas-table tr:nth-child(even) {
            background: #f9fafb;
        }
        .status-pago {
            background: #dcfce7;
            color: #166534;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .status-pendente {
            background: #fef3c7;
            color: #92400e;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .btn-print {
            background: #3b82f6;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: block;
            margin: 30px auto;
        }
        @media print {
            .btn-print { display: none; }
            body { background: white; margin: 0; }
        }
        @media (max-width: 768px) {
            .info-grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 24px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ CARN√ä DE DOA√á√ÉO</h1>
            <p>Sistema de Controle de Doa√ß√µes</p>
            <p>Documento: ${numeroDocumento} | ${dataGeracao}</p>
        </div>
        
        <div class="content">
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-title">üë§ Dados do Doador</div>
                    <div class="info-item">
                        <span class="info-label">Nome:</span>
                        ${doador.nome}
                    </div>
                    <div class="info-item">
                        <span class="info-label">C√≥digo:</span>
                        ${doador.codigo_doador || 'D' + String(doador.id).padStart(3, '0')}
                    </div>
                    ${doador.cpf ? `<div class="info-item">
                        <span class="info-label">CPF:</span>
                        ${formatarCPF(doador.cpf)}
                    </div>` : ''}
                    <div class="info-item">
                        <span class="info-label">Telefone:</span>
                        ${doador.telefone1}${doador.telefone2 ? ' / ' + doador.telefone2 : ''}
                    </div>
                </div>
                
                <div class="info-card">
                    <div class="info-title">üí∞ Dados da Doa√ß√£o</div>
                    <div class="info-item">
                        <span class="info-label">Tipo:</span>
                        ${doacao.tipo}
                    </div>
                    <div class="info-item">
                        <span class="info-label">Data:</span>
                        ${formatarData(doacao.data_doacao)}
                    </div>
                    <div class="info-item">
                        <span class="info-label">Recorrente:</span>
                        ${doacao.recorrente ? 'Sim' : 'N√£o'}
                    </div>
                </div>
            </div>
            
            <div class="valor-destaque">
                <div class="valor">R$ ${doacao.valor.toFixed(2).replace('.', ',')}</div>
                <div>Valor da Doa√ß√£o</div>
            </div>
            
            <div class="qr-section">
                <div style="font-size: 48px; margin-bottom: 10px;">üì±</div>
                <h3>QR Code PIX</h3>
                <p><strong>PIX:</strong> pix@organizacao.org.br</p>
                <p><strong>Valor:</strong> R$ ${doacao.valor.toFixed(2).replace('.', ',')}</p>
            </div>
            
            <h2 style="margin: 30px 0 20px 0;">üìã Parcelas de Pagamento</h2>
            
            <table class="parcelas-table">
                <thead>
                    <tr>
                        <th>Parcela</th>
                        <th>Vencimento</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Data Pagamento</th>
                    </tr>
                </thead>
                <tbody>
                    ${gerarParcelasHTML(doacao, historico)}
                </tbody>
            </table>
        </div>
        
        <button class="btn-print" onclick="window.print()">
            üñ®Ô∏è Imprimir Carn√™
        </button>
    </div>
    
    <script>
        function formatarCPF(cpf) {
            return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
        }
        
        function formatarData(data) {
            return new Date(data + 'T00:00:00').toLocaleDateString('pt-BR');
        }
        
        function gerarParcelasHTML(doacao, historico) {
            const parcelas = doacao.parcelas_totais || (doacao.recorrente ? 12 : 1);
            let html = '';
            
            for (let i = 1; i <= parcelas; i++) {
                const dataVenc = calcularVencimento(doacao.data_doacao, i - 1);
                const pagamento = buscarPagamento(historico, dataVenc);
                const pago = !!pagamento;
                
                html += \`
                    <tr>
                        <td><strong>\${i.toString().padStart(2, '0')}/\${parcelas.toString().padStart(2, '0')}</strong></td>
                        <td>\${formatarData(dataVenc)}</td>
                        <td style="font-weight: bold; color: #059669;">R$ \${doacao.valor.toFixed(2).replace('.', ',')}</td>
                        <td>
                            <span class="\${pago ? 'status-pago' : 'status-pendente'}">
                                \${pago ? '‚úÖ PAGO' : '‚è≥ PENDENTE'}
                            </span>
                        </td>
                        <td>\${pago ? formatarData(pagamento.data_pagamento) : '-'}</td>
                    </tr>
                \`;
            }
            
            return html;
        }
        
        function calcularVencimento(dataInicial, meses) {
            const data = new Date(dataInicial + 'T00:00:00');
            if (meses > 0) {
                data.setMonth(data.getMonth() + meses);
            }
            return data.toISOString().substring(0, 10);
        }
        
        function buscarPagamento(historico, dataVenc) {
            if (!historico || !Array.isArray(historico)) return null;
            
            const vencimento = new Date(dataVenc);
            for (let pgto of historico) {
                const dataPgto = new Date(pgto.data_pagamento);
                const diff = Math.abs((dataPgto - vencimento) / (1000 * 60 * 60 * 24));
                if (diff <= 7) return pgto;
            }
            return null;
        }
    </script>
</body>
</html>`;
}




// ===============================================================================
// EXPORTA√á√ÉO DE DADOS PROFISSIONAL - Vers√£o 1.1.5
// Data: 05/09/2025
// ===============================================================================



function mostrarModalExportacao() {
    // Remover modal existente
    const existingModal = document.getElementById('export-modal');
    if (existingModal) existingModal.remove();
    
    const modalHTML = `
        <div id="export-modal" style="
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); z-index: 999999;
            display: flex; justify-content: center; align-items: center;
        ">
            <div style="
                background: white; padding: 40px; border-radius: 16px;
                max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            ">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                    <h2 style="margin: 0; font-size: 28px; font-weight: bold; color: #1f2937;">
                        üìä Exportar Dados
                    </h2>
                    <button onclick="fecharModalExportacao()" style="
                        background: none; border: none; font-size: 32px; cursor: pointer;
                        color: #666; border-radius: 8px; padding: 8px;
                    ">√ó</button>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px;">
                    <button onclick="exportarPDF()" style="
                        padding: 20px 15px; border: 2px solid #dc2626; background: #fef2f2;
                        color: #dc2626; border-radius: 12px; cursor: pointer;
                        font-size: 14px; font-weight: bold; text-align: center;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#fee2e2'" onmouseout="this.style.background='#fef2f2'">
                        <div style="font-size: 24px; margin-bottom: 8px;">üìÑ</div>
                        <div>Relat√≥rio PDF</div>
                    </button>
                    
                    <button onclick="exportarCSV()" style="
                        padding: 20px 15px; border: 2px solid #059669; background: #f0fdf4;
                        color: #059669; border-radius: 12px; cursor: pointer;
                        font-size: 14px; font-weight: bold; text-align: center;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#dcfce7'" onmouseout="this.style.background='#f0fdf4'">
                        <div style="font-size: 24px; margin-bottom: 8px;">üìä</div>
                        <div>Planilha CSV</div>
                    </button>
                    
                    <button onclick="exportarJSON()" style="
                        padding: 20px 15px; border: 2px solid #2563eb; background: #eff6ff;
                        color: #2563eb; border-radius: 12px; cursor: pointer;
                        font-size: 14px; font-weight: bold; text-align: center;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#dbeafe'" onmouseout="this.style.background='#eff6ff'">
                        <div style="font-size: 24px; margin-bottom: 8px;">‚ö°</div>
                        <div>Dados JSON</div>
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 20px; border-radius: 12px; text-align: center;">
                    <h4 style="margin: 0 0 15px 0;">üìà Estat√≠sticas</h4>
                    <div id="export-stats">Carregando...</div>
                </div>
                
                <div style="text-align: right; margin-top: 20px;">
                    <button onclick="fecharModalExportacao()" style="
                        padding: 12px 25px; border: 2px solid #d1d5db; background: white;
                        color: #374151; border-radius: 8px; cursor: pointer; font-weight: bold;
                    ">Cancelar</button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    carregarEstatisticas();
}

async function carregarEstatisticas() {
    try {
        const [resumoResponse, doacoesResponse] = await Promise.all([
            fetch('/api/relatorios/resumo'),
            fetch('/api/doacoes')
        ]);
        
        const resumo = await resumoResponse.json();
        const doacoes = await doacoesResponse.json();
        
        document.getElementById('export-stats').innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div>
                    <div style="font-size: 24px; font-weight: bold;">R$ ${(resumo.total_arrecadado || 0).toFixed(2).replace('.', ',')}</div>
                    <div>Total Arrecadado</div>
                </div>
                <div>
                    <div style="font-size: 24px; font-weight: bold;">${resumo.total_doacoes || 0}</div>
                    <div>Doa√ß√µes</div>
                </div>
            </div>
            <div style="margin-top: 10px; font-size: 13px; opacity: 0.8;">
                ${doacoes.length || 0} registros dispon√≠veis
            </div>
        `;
    } catch (error) {
        document.getElementById('export-stats').innerHTML = 'Erro ao carregar';
    }
}

function fecharModalExportacao() {
    const modal = document.getElementById('export-modal');
    if (modal) modal.remove();
}

async function exportarPDF() {
    try {
        showNotification('Gerando PDF...', 'info');
        
        const [resumoResponse, doacoesResponse] = await Promise.all([
            fetch('/api/relatorios/resumo'),
            fetch('/api/doacoes')
        ]);
        
        const resumo = await resumoResponse.json();
        const doacoes = await doacoesResponse.json();
        
        const printWindow = window.open('', '_blank');
        if (!printWindow) throw new Error('Popup bloqueado!');
        
        printWindow.document.write(criarRelatorioPDF(resumo, doacoes));
        printWindow.document.close();
        printWindow.focus();
        
        fecharModalExportacao();
        showNotification('PDF gerado com sucesso!', 'success');
        
    } catch (error) {
        showNotification('Erro ao gerar PDF: ' + error.message, 'error');
    }
}

async function exportarCSV() {
    try {
        showNotification('Gerando CSV...', 'info');
        
        const response = await fetch('/api/doacoes');
        const doacoes = await response.json();
        
        const csvContent = criarCSV(doacoes);
        
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `doacoes_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
        
        fecharModalExportacao();
        showNotification('CSV baixado com sucesso!', 'success');
        
    } catch (error) {
        showNotification('Erro ao gerar CSV: ' + error.message, 'error');
    }
}

async function exportarJSON() {
    try {
        showNotification('Gerando JSON...', 'info');
        
        const [resumoResponse, doacoesResponse] = await Promise.all([
            fetch('/api/relatorios/resumo'),
            fetch('/api/doacoes')
        ]);
        
        const resumo = await resumoResponse.json();
        const doacoes = await doacoesResponse.json();
        
        const jsonContent = JSON.stringify({
            metadata: {
                exportado_em: new Date().toISOString(),
                total_registros: doacoes.length,
                sistema: 'Sistema de Doa√ß√µes v1.1.5'
            },
            resumo,
            doacoes
        }, null, 2);
        
        const blob = new Blob([jsonContent], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `doacoes_${new Date().toISOString().split('T')[0]}.json`;
        link.click();
        
        fecharModalExportacao();
        showNotification('JSON baixado com sucesso!', 'success');
        
    } catch (error) {
        showNotification('Erro ao gerar JSON: ' + error.message, 'error');
    }
}

function criarRelatorioPDF(resumo, doacoes) {
    return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Relat√≥rio de Doa√ß√µes</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; color: #333; }
        .header { text-align: center; background: linear-gradient(135deg, #3b82f6, #1d4ed8); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; }
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin: 30px 0; }
        .summary-card { background: #f8fafc; padding: 25px; border-radius: 12px; text-align: center; }
        .summary-card h3 { margin: 0 0 10px 0; color: #6b7280; font-size: 14px; }
        .summary-card .value { font-size: 28px; font-weight: bold; color: #1f2937; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #374151; color: white; padding: 15px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        tr:nth-child(even) { background: #f9fafb; }
        .btn-print { background: #3b82f6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: block; margin: 30px auto; }
        @media print { .btn-print { display: none; } }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìä RELAT√ìRIO DE DOA√á√ïES</h1>
        <p>Sistema de Controle de Doa√ß√µes v1.1.5</p>
        <p>Gerado em ${new Date().toLocaleDateString('pt-BR')} √†s ${new Date().toLocaleTimeString('pt-BR')}</p>
    </div>
    
    <div class="summary-grid">
        <div class="summary-card">
            <h3>üí∞ Total Arrecadado</h3>
            <div class="value">R$ ${(resumo.total_arrecadado || 0).toFixed(2).replace('.', ',')}</div>
        </div>
        <div class="summary-card">
            <h3>üìä Total de Doa√ß√µes</h3>
            <div class="value">${resumo.total_doacoes || 0}</div>
        </div>
        <div class="summary-card">
            <h3>üîÑ Doa√ß√µes Recorrentes</h3>
            <div class="value">${resumo.doacoes_recorrentes || 0}</div>
        </div>
    </div>
    
    <h2>üìã Detalhamento das Doa√ß√µes</h2>
    
    ${doacoes.length > 0 ? `
    <table>
        <thead>
            <tr>
                <th>C√≥digo</th>
                <th>Doador</th>
                <th>Valor</th>
                <th>Tipo</th>
                <th>Data</th>
                <th>Recorrente</th>
            </tr>
        </thead>
        <tbody>
            ${doacoes.map(d => `
                <tr>
                    <td>${d.codigo_doador || 'D' + String(d.doador_id).padStart(3, '0')}</td>
                    <td>${d.nome_doador || 'N/A'}</td>
                    <td style="font-weight: bold; color: #059669;">R$ ${d.valor.toFixed(2).replace('.', ',')}</td>
                    <td>${d.tipo}</td>
                    <td>${new Date(d.data_doacao + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${d.recorrente ? 'Sim' : 'N√£o'}</td>
                </tr>
            `).join('')}
        </tbody>
    </table>
    ` : '<p style="text-align: center; padding: 40px;">Nenhuma doa√ß√£o encontrada.</p>'}
    
    <button class="btn-print" onclick="window.print()">üñ®Ô∏è Imprimir PDF</button>
</body>
</html>`;
}

function criarCSV(doacoes) {
    const headers = ['C√≥digo', 'Doador', 'Valor', 'Tipo', 'Data', 'Recorrente', 'Telefone', 'Observa√ß√µes'];
    const rows = [headers.join(',')];
    
    doacoes.forEach(d => {
        const row = [
            `"${d.codigo_doador || 'D' + String(d.doador_id).padStart(3, '0')}"`,
            `"${d.nome_doador || ''}"`,
            `"${d.valor.toFixed(2).replace('.', ',')}"`,
            `"${d.tipo}"`,
            `"${new Date(d.data_doacao + 'T00:00:00').toLocaleDateString('pt-BR')}"`,
            `"${d.recorrente ? 'Sim' : 'N√£o'}"`,
            `"${d.telefone1 || ''}"`,
            `"${(d.observacoes || '').replace(/"/g, '""')}"`
        ];
        rows.push(row.join(','));
    });
    
    return '\uFEFF' + rows.join('\n');
}




// ===============================================================================
// GERA√á√ÉO DE CARN√ä PROFISSIONAL - Vers√£o 1.1.5 FINAL
// Data: 05/09/2025
// ===============================================================================

async function generateCarne(doacaoId) {
    try {
        alert('üîç Iniciando gera√ß√£o do carn√™...');
        
        // Buscar dados b√°sicos
        const doacaoResponse = await fetch(`/api/doacoes/${doacaoId}`);
        const doacao = await doacaoResponse.json();
        const doadorResponse = await fetch(`/api/doadores/${doacao.doador_id}`);
        const doador = await doadorResponse.json();
        
        alert('üìÑ Dados carregados. Criando janela...');
        
        // Criar janela
        const novaJanela = window.open('', '_blank', 'width=900,height=700');
        
        // HTML M√çNIMO com selo e QR FOR√áADOS
        const htmlTeste = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>TESTE - Carn√™ com Selo e QR</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f0f0f0;
        }
        
        /* SELO TESTE - SUPER VIS√çVEL */
        #selo-teste {
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            width: 150px !important;
            height: 150px !important;
            background: red !important;
            color: white !important;
            border: 5px solid black !important;
            border-radius: 50% !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            font-size: 14px !important;
            font-weight: bold !important;
            z-index: 99999 !important;
            box-shadow: 0 0 20px rgba(255,0,0,0.8) !important;
        }
        
        /* QR CODE TESTE - SUPER VIS√çVEL */
        .qr-teste {
            width: 200px !important;
            height: 200px !important;
            background: blue !important;
            color: white !important;
            border: 5px solid black !important;
            margin: 20px auto !important;
            display: flex !important;
            justify-content: center !important;
            align-items: center !important;
            text-align: center !important;
            font-size: 16px !important;
            font-weight: bold !important;
        }
        
        .cabecalho {
            text-align: center;
            padding: 20px;
            background: yellow;
            border: 3px solid black;
            margin-bottom: 20px;
        }
        
        .parcela-teste {
            border: 3px solid black;
            padding: 20px;
            margin: 20px 0;
            background: white;
        }
    </style>
</head>
<body>
    <!-- SELO TESTE -->
    <div id="selo-teste">
        üîí<br>
        SELO<br>
        TESTE<br>
        VIS√çVEL
    </div>
    
    <!-- CABE√áALHO -->
    <div class="cabecalho">
        <h1>üîç TESTE - CARN√ä COM SELO E QR</h1>
        <h2>${doador.nome}</h2>
        <p>C√≥digo: ${doador.codigo_doador || 'D' + doador.id}</p>
    </div>
    
    <!-- PARCELA TESTE -->
    <div class="parcela-teste">
        <h3>üìÑ PARCELA DE TESTE</h3>
        <p><strong>Valor:</strong> R$ ${doacao.valor.toFixed(2).replace('.', ',')}</p>
        <p><strong>Tipo:</strong> ${doacao.tipo}</p>
        
        <!-- QR CODE TESTE -->
        <div class="qr-teste">
            üì±<br>
            QR CODE<br>
            TESTE<br>
            VIS√çVEL
        </div>
        
        <p style="color: red; font-weight: bold;">
            ‚ö†Ô∏è Se voc√™ est√° vendo este texto, o carn√™ est√° sendo gerado!<br>
            ‚úÖ Se voc√™ v√™ o SELO VERMELHO no canto, o CSS est√° funcionando!<br>
            ‚úÖ Se voc√™ v√™ o QR CODE AZUL, tudo est√° OK!
        </p>
    </div>
    
    <div style="text-align: center; margin: 30px;">
        <button onclick="window.print()" style="
            padding: 15px 30px; 
            background: green; 
            color: white; 
            border: none; 
            font-size: 16px; 
            cursor: pointer;
        ">üñ®Ô∏è Imprimir Teste</button>
    </div>
    
    <script>
        // Debug no console
        console.log('üîç Carn√™ de teste carregado!');
        console.log('Selo:', document.getElementById('selo-teste'));
        console.log('QR Codes:', document.querySelectorAll('.qr-teste'));
        
        // Garantir que o selo seja vis√≠vel
        setTimeout(() => {
            const selo = document.getElementById('selo-teste');
            if (selo) {
                selo.style.background = 'red';
                selo.style.display = 'flex';
                console.log('‚úÖ Selo for√ßado como vis√≠vel');
            }
        }, 100);
    </script>
</body>
</html>`;
        
        // Escrever na janela
        novaJanela.document.write(htmlTeste);
        novaJanela.document.close();
        
        alert('‚úÖ Carn√™ de teste criado! Verifique se o SELO VERMELHO e QR CODE AZUL est√£o vis√≠veis.');
        
    } catch (error) {
        alert('‚ùå Erro no teste: ' + error.message);
        console.error('Erro:', error);
    }
}

// ===============================================================================

/**
 * Calcular data de vencimento para parcelas
 * Vers√£o: 1.1.2
 */

/**
 * Buscar pagamento no hist√≥rico por data pr√≥xima
 * Vers√£o: 1.1.2
 */
function buscarPagamentoHistorico(historico, dataVencimento) {
    const vencimento = new Date(dataVencimento);
    
    for (let i = 0; i < historico.length; i++) {
        const pgto = historico[i];
        const dataPgto = new Date(pgto.data_pagamento);
        const diff = Math.abs((dataPgto - vencimento) / (1000 * 60 * 60 * 24));
        if (diff <= 5) { // Toler√¢ncia de 5 dias
            return pgto;
        }
    }
    return null;
}

/**
 * Montar endere√ßo completo do doador
 * Vers√£o: 1.1.2
 */
function montarEndereco(doador) {
    const parts = [];
    if (doador.logradouro) parts.push(doador.logradouro);
    if (doador.numero) parts.push(doador.numero);
    if (doador.complemento) parts.push(doador.complemento);
    if (doador.bairro) parts.push(doador.bairro);
    if (doador.cidade) parts.push(doador.cidade);
    if (doador.estado) parts.push(doador.estado);
    if (doador.cep) parts.push('CEP: ' + doador.cep);
    
    return parts.length > 0 ? parts.join(', ') : 'Endere√ßo n√£o informado';
}

/**
 * Formatar CPF para exibi√ß√£o
 * Vers√£o: 1.1.2
 */
function formatCPFDisplay(cpf) {
    if (!cpf) return '';
    cpf = cpf.replace(/\D/g, '');
    return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
}

console.log('‚úÖ Fun√ß√µes de Edi√ß√£o e Carn√™ restauradas - v1.1.2');


// ===============================================================================
// FUN√á√ÉO PARA SALVAR NOVA DOA√á√ÉO - Vers√£o Simples
// ===============================================================================
window.addDonation = async function() {
    try {
        console.log('üöÄ Iniciando salvamento de doa√ß√£o...');
        
        // Coletar TODOS os dados do formul√°rio - v1.1.7
        const formData = {
            // Dados b√°sicos
            donor: document.getElementById('input-donor')?.value?.trim() || '',
            phone1: document.getElementById('input-phone1')?.value?.trim() || '',
            phone2: document.getElementById('input-phone2')?.value?.trim() || '',
            cpf: document.getElementById('input-cpf')?.value?.trim() || '',
            contact: document.getElementById('input-contact')?.value?.trim() || '',
            
            // Dados da doa√ß√£o
            amount: parseFloat(document.getElementById('input-amount')?.value || 0),
            date: document.getElementById('input-date')?.value || '',
            type: document.getElementById('input-type')?.value || 'DINHEIRO',
            notes: document.getElementById('input-notes')?.value?.trim() || '',
            
            // Endere√ßo
            cep: document.getElementById('input-cep')?.value?.trim() || '',
            logradouro: document.getElementById('input-logradouro')?.value?.trim() || '',
            numero: document.getElementById('input-numero')?.value?.trim() || '',
            complemento: document.getElementById('input-complemento')?.value?.trim() || '',
            bairro: document.getElementById('input-bairro')?.value?.trim() || '',
            cidade: document.getElementById('input-cidade')?.value?.trim() || '',
            estado: document.getElementById('input-estado')?.value?.trim() || '',
            
            // PARCELAS RECORRENTES - CORRE√á√ÉO v1.1.7
            recorrente: document.getElementById('input-recurrent')?.checked || false,
            parcelas: 1,
            proxima_parcela: null
        ,
        // Campos de parcelas recorrentes v2.3.0
        recorrente: document.getElementById('input-recurrent')?.checked || false,
        parcelas: parseInt(document.getElementById('input-parcelas')?.value || 1),
        valor_parcelas_futuras: parseFloat(document.getElementById('input-valor-parcelas')?.value || 0),
        proxima_parcela: document.getElementById('input-proxima-parcela')?.value || null
    };
        
        // Se for recorrente, coletar dados de parcelas
        if (formData.recorrente) {
            const parcelasInput = document.getElementById('input-parcelas');
            const proximaInput = document.getElementById('input-proxima-parcela');
            
            formData.parcelas = parseInt(parcelasInput?.value) || 12;
            formData.proxima_parcela = proximaInput?.value || null;
            
            // Calcular pr√≥xima parcela se n√£o informada
            if (!formData.proxima_parcela && formData.date) {
                const dataDoacao = new Date(formData.date);
                dataDoacao.setMonth(dataDoacao.getMonth() + 1);
                formData.proxima_parcela = dataDoacao.toISOString().split('T')[0];
            }
            
            console.log('üìä Doa√ß√£o Recorrente:', {
                parcelas: formData.parcelas,
                proxima: formData.proxima_parcela
            });
        }
        
        // Valida√ß√£o
        if (!formData.donor) {
            alert('Nome √© obrigat√≥rio');
            return;
        }
        if (!formData.phone1) {
            alert('Telefone √© obrigat√≥rio');
            return;
        }
        
        // Validar valor das parcelas futuras (opcional com valor padr√£o)
        if (formData.recorrente && formData.valor_parcelas_futuras && formData.valor_parcelas_futuras <= 0) {
            alert('Valor das parcelas futuras deve ser maior que zero');
            return;
        }
        
        // Se recorrente mas sem valor das parcelas, usar valor da doa√ß√£o dividido pelas parcelas
        if (formData.recorrente && (!formData.valor_parcelas_futuras || formData.valor_parcelas_futuras === 0)) {
            const valorSugerido = (formData.amount / (formData.parcelas_totais || 2)).toFixed(2);
            const confirmar = confirm(`Valor das parcelas futuras n√£o informado.\n\nUsar valor padr√£o de R$ ${valorSugerido} por parcela?\n\n(Clique OK para aceitar ou Cancelar para informar manualmente)`);
            
            if (confirmar) {
                formData.valor_parcelas_futuras = parseFloat(valorSugerido);
                console.log('üí∞ Valor padr√£o aplicado:', formData.valor_parcelas_futuras);
            } else {
                alert('Por favor, informe o valor das parcelas futuras');
                return;
            }
        }
        
        if (!formData.amount || formData.amount <= 0) {
            alert('Valor deve ser maior que zero');
            return;
        }
        
        console.log('üì§ Enviando dados:', formData);
        
        // Enviar para servidor
        const response = await fetch('/api/doacoes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            const result = await response.json();
            const tipoMsg = formData.recorrente ? 
                `recorrente com ${formData.parcelas} parcelas` : 
                '√∫nica';
            alert(`‚úÖ Doa√ß√£o ${tipoMsg} salva com sucesso!`);
            closeModal();
            loadDashboard();
        } else {
            const error = await response.json();
            alert('‚ùå Erro: ' + (error.message || 'Erro ao salvar'));
        }
        
    } catch (error) {
        console.error('‚ùå Erro:', error);
        alert('‚ùå Erro ao salvar doa√ß√£o: ' + error.message);
    }
}

// ===============================================================================
// FUN√á√ÉO PARA FECHAR MODAL - Vers√£o Simples  
// ===============================================================================
window.closeModal = function() {
    try {
        const modal = document.getElementById('modal');
        if (modal) {
            modal.style.display = 'none';
            
            // Limpar campos b√°sicos
            const campos = ['input-donor', 'input-phone1', 'input-amount', 'input-date', 'input-notes', 'input-contact', 'input-cpf'];
            campos.forEach(id => {
                const campo = document.getElementById(id);
                if (campo) campo.value = '';
            });
            
            const checkbox = document.getElementById('input-recurrent');
            if (checkbox) checkbox.checked = false;
            
            console.log('Modal fechado');
        }
    } catch (error) {
        console.error('Erro ao fechar modal:', error);
    }
};
/**
 * Mostrar hist√≥rico simples com estrutura de parcelas
 * Vers√£o: 1.2.2 - CORRE√á√ÉO CIR√öRGICA
 */
window.showSimpleHistory = async function(doacaoId) {
    console.log('üìã Carregando hist√≥rico com parcelas para doa√ß√£o:', doacaoId);
    
    try {
        // Buscar dados completos da doa√ß√£o
        const doacaoResponse = await fetch(`/api/doacoes/${doacaoId}`);
        const doacao = await doacaoResponse.json();
        
        if (!doacaoResponse.ok) {
            throw new Error('Doa√ß√£o n√£o encontrada');
        }
        
        // Buscar hist√≥rico de pagamentos
        const historicoResponse = await fetch(`/api/doacoes/${doacaoId}/historico`);
        const historico = await historicoResponse.json();
        
        // Buscar parcelas futuras
        const parcelasResponse = await fetch(`/api/doacoes/${doacaoId}/parcelas`);
        const parcelasFuturas = await parcelasResponse.json();
        
        // Montar estrutura completa das parcelas
        const numParcelas = doacao.parcelas_totais || 1;
        const valorParcela = doacao.valor / (doacao.recorrente ? numParcelas : 1);
        const parcelasCompletas = [];
        
        for (let i = 1; i <= numParcelas; i++) {
            const dataVencimento = calcularDataVencimento(doacao.data_doacao, i - 1, doacao.recorrente);
            const pagamento = buscarPagamentoProximo(historico, dataVencimento);
            const parcelaFutura = parcelasFuturas.find(p => p.numero_parcela === i);
            
            parcelasCompletas.push({
                numero: i,
                data_vencimento: dataVencimento,
                valor: valorParcela,
                status: pagamento ? 'Pago' : 'Pendente',
                data_pagamento: pagamento ? pagamento.data_pagamento : null,
                pagamento_id: pagamento ? pagamento.id : null,
                parcela_futura_id: parcelaFutura ? parcelaFutura.id : null
            });
        }
        
        mostrarModalParcelasCompletas(doacao, parcelasCompletas);
        
    } catch (error) {
        console.error('‚ùå Erro ao carregar hist√≥rico:', error);
        alert('Erro ao carregar hist√≥rico: ' + error.message);
    }
};

/**
 * Calcular data de vencimento da parcela
 * Vers√£o: 1.2.2
 */
function calcularDataVencimento(dataInicial, meses, recorrente) {
    const data = new Date(dataInicial + 'T00:00:00');
    if (recorrente && meses > 0) {
        data.setMonth(data.getMonth() + meses);
    }
    return data.toISOString().substring(0, 10);
}

/**
 * Buscar pagamento pr√≥ximo √† data de vencimento
 * Vers√£o: 1.2.2
 */
function buscarPagamentoProximo(historico, dataVencimento) {
    if (!historico || !Array.isArray(historico)) return null;
    
    const vencimento = new Date(dataVencimento + 'T00:00:00');
    
    for (let pagamento of historico) {
        const dataPagamento = new Date(pagamento.data_pagamento + 'T00:00:00');
        const diffDias = Math.abs((dataPagamento - vencimento) / (1000 * 60 * 60 * 24));
        
        // Toler√¢ncia de 10 dias para considerar que √© o pagamento da parcela
        if (diffDias <= 730) {
            return pagamento;
        }
    }
    
    return null;
}

/**
 * Mostrar modal com todas as parcelas
 * Vers√£o: 1.2.2
 */
function mostrarModalParcelasCompletas(doacao, parcelas) {
    // Remover modal existente
    const existingModal = document.getElementById('modal-parcelas-completas');
    if (existingModal) existingModal.remove();
    
    const totalPago = parcelas
        .filter(p => p.status === 'Pago')
        .reduce((sum, p) => sum + p.valor, 0);
    
    const parcelasPagas = parcelas.filter(p => p.status === 'Pago').length;
    const parcelasPendentes = parcelas.filter(p => p.status === 'Pendente').length;
    
    const modalHTML = `
    <div id="modal-parcelas-completas" style="
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background: rgba(0, 0, 0, 0.8); z-index: 999999;
        display: flex; justify-content: center; align-items: center;
    ">
        <div style="
            background: white; padding: 30px; border-radius: 12px;
            max-width: 900px; width: 95%; max-height: 80vh; overflow-y: auto;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; font-size: 24px; color: #1f2937;">
                    üìã Hist√≥rico de Parcelas
                </h2>
                <button onclick="fecharModalParcelas()" style="
                    background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;
                ">&times;</button>
            </div>
            
            <!-- Informa√ß√µes do Doador -->
            <div style="background: #f3f4f6; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <h3 style="margin: 0 0 10px 0; color: #1f2937;">${doacao.nome_doador} (${doacao.codigo_doador})</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div>
                        <strong>Valor Total:</strong><br>
                        <span style="font-size: 18px; color: #059669;">R$ ${doacao.valor.toFixed(2).replace('.', ',')}</span>
                    </div>
                    <div>
                        <strong>Tipo:</strong><br>
                        <span style="color: #374151;">${doacao.tipo}</span>
                    </div>
                    <div>
                        <strong>Total de Parcelas:</strong><br>
                        <span style="color: #374151;">${doacao.parcelas_totais || 1} parcelas</span>
                    </div>
                </div>
            </div>
            
            <!-- Resumo -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
                <div style="text-align: center; padding: 15px; background: #dcfce7; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #166534;">${parcelasPagas}</div>
                    <div style="color: #166534;">Pagas</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #fef3c7; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #92400e;">${parcelasPendentes}</div>
                    <div style="color: #92400e;">Pendentes</div>
                </div>
                <div style="text-align: center; padding: 15px; background: #e0f2fe; border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: bold; color: #0277bd;">R$ ${totalPago.toFixed(2).replace('.', ',')}</div>
                    <div style="color: #0277bd;">Total Pago</div>
                </div>
            </div>
            
            <!-- Tabela de Parcelas -->
            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                    <thead>
                        <tr style="background: #f9fafb;">
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Parcela</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Vencimento</th>
                            <th style="padding: 12px; text-align: right; border-bottom: 2px solid #e5e7eb;">Valor</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">Status</th>
                            <th style="padding: 12px; text-align: left; border-bottom: 2px solid #e5e7eb;">Data Pagamento</th>
                            <th style="padding: 12px; text-align: center; border-bottom: 2px solid #e5e7eb;">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${parcelas.map(parcela => `
                            <tr style="border-bottom: 1px solid #e5e7eb;">
                                <td style="padding: 12px;">
                                    <strong>${String(parcela.numero).padStart(2, '0')}/${String(doacao.parcelas_totais).padStart(2, '0')}</strong>
                                </td>
                                <td style="padding: 12px;">${formatarDataBrasil(parcela.data_vencimento)}</td>
                                <td style="padding: 12px; text-align: right; font-weight: bold;">
                                    R$ ${parcela.valor.toFixed(2).replace('.', ',')}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    <span style="
                                        padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold;
                                        background: ${parcela.status === 'Pago' ? '#dcfce7' : '#fef3c7'};
                                        color: ${parcela.status === 'Pago' ? '#166534' : '#92400e'};
                                    ">
                                        ${parcela.status === 'Pago' ? '‚úÖ PAGO' : '‚è≥ PENDENTE'}
                                    </span>
                                </td>
                                <td style="padding: 12px;">
                                    ${parcela.data_pagamento ? formatarDataBrasil(parcela.data_pagamento) : '-'}
                                </td>
                                <td style="padding: 12px; text-align: center;">
                                    ${parcela.status === 'Pendente' ? `
                                        <button onclick="pagarParcela(${doacao.id}, ${parcela.numero}, ${parcela.valor})" style="
                                            background: #10b981; color: white; border: none; padding: 6px 12px;
                                            border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
                                        ">
                                            üí∞ Pagar
                                        </button>
                                    ` : `
                                        <span style="color: #6b7280; font-size: 12px;">Pago</span>
                                    `}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            
            <!-- Bot√µes -->
            <div style="display: flex; gap: 15px; justify-content: flex-end;">
                <button onclick="fecharModalParcelas()" style="
                    padding: 10px 20px; border: 2px solid #d1d5db; background: white;
                    border-radius: 8px; cursor: pointer; font-weight: bold;
                ">Fechar</button>
                <button onclick="generateCarne(${doacao.id})" style="
                    padding: 10px 20px; border: none; background: #3b82f6; color: white;
                    border-radius: 8px; cursor: pointer; font-weight: bold;
                ">üñ®Ô∏è Gerar Carn√™</button>
            </div>
        </div>
    </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}

/**
 * Fechar modal de parcelas
 * Vers√£o: 1.2.2
 */
window.fecharModalParcelas = function() {
    const modal = document.getElementById('modal-parcelas-completas');
    if (modal) modal.remove();
};

/**
 * Formatar data para padr√£o brasileiro
 * Vers√£o: 1.2.2
 */
function formatarDataBrasil(dataISO) {
    if (!dataISO) return '';
    const data = new Date(dataISO + 'T00:00:00');
    return data.toLocaleDateString('pt-BR');
}

/**
 * Pagar parcela espec√≠fica
 * Vers√£o: 1.2.2
 */

/**
 * Validar e converter data brasileira para ISO
 * Vers√£o: 1.2.3
 */
function validarDataBrasileira(dataBR) {
    if (!dataBR) return null;
    
    // Se j√° est√° no formato ISO, manter
    if (dataBR.match(/^\d{4}-\d{2}-\d{2}$/)) {
        return dataBR;
    }
    
    // Se est√° no formato brasileiro DD/MM/AAAA
    if (dataBR.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
        const [dia, mes, ano] = dataBR.split('/');
        
        // Valida√ß√µes b√°sicas
        const diaNum = parseInt(dia);
        const mesNum = parseInt(mes);
        const anoNum = parseInt(ano);
        
        if (diaNum < 1 || diaNum > 31) {
            alert('Dia inv√°lido! Use valores entre 1 e 31.');
            return null;
        }
        
        if (mesNum < 1 || mesNum > 12) {
            alert('M√™s inv√°lido! Use valores entre 1 e 12.');
            return null;
        }
        
        if (anoNum < 2020 || anoNum > 2030) {
            alert('Ano inv√°lido! Use valores entre 2020 e 2030.');
            return null;
        }
        
        // Converter para formato ISO
        return `${anoNum}-${mesNum.toString().padStart(2, '0')}-${diaNum.toString().padStart(2, '0')}`;
    }
    
    alert('Formato de data inv√°lido! Use DD/MM/AAAA (ex: 18/09/2025)');
    return null;
}

window.pagarParcela = async function(doacaoId, numeroParcela, valor) {
    const hoje = new Date();
    const dataHojeBR = hoje.toLocaleDateString('pt-BR');
    const dataPagamento = prompt(`Data do pagamento da parcela ${numeroParcela} (DD/MM/AAAA):`, dataHojeBR);
    
    // Converter data brasileira para formato ISO se necess√°rio
    let dataISO = dataPagamento;
    if (dataPagamento && dataPagamento.includes('/')) {
        const [dia, mes, ano] = dataPagamento.split('/');
        if (dia && mes && ano) {
            dataISO = `${ano}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
        }
    }
    
    if (!dataPagamento) return;
    
    // Validar e converter data
    const dataValidada = validarDataBrasileira(dataPagamento);
    if (!dataValidada) return;
    
    try {
        const response = await fetch(`/api/doacoes/${doacaoId}/pagar-parcela`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                numero_parcela: numeroParcela,
                data_pagamento: dataValidada,
                valor: valor
            })
        });
        
        if (response.ok) {
            alert(`‚úÖ Pagamento da parcela ${numeroParcela} registrado com sucesso!`);
            // Recarregar modal
            showSimpleHistory(doacaoId);
            // Recarregar dashboard
            loadDashboard();
        } else {
            const error = await response.json();
            alert('‚ùå Erro: ' + error.message);
        }
    } catch (error) {
        console.error('‚ùå Erro ao pagar parcela:', error);
        alert('‚ùå Erro ao registrar pagamento: ' + error.message);
    }
};

