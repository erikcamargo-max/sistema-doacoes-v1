# üìã CONTROLE DE VERS√ÉO - SISTEMA DE DOA√á√ïES

## üéØ INFORMA√á√ïES DO PROJETO

### Identifica√ß√£o
- **Nome do Sistema:** Sistema de Controle de Doa√ß√µes
- **Vers√£o Atual:** 1.1.0 ‚úÖ
- **Data de In√≠cio:** Agosto/2025
- **√öltima Atualiza√ß√£o:** 01/Setembro/2025
- **Reposit√≥rio:** https://github.com/erikcamargo-max/sistema-doacoes-v1
- **Stack Tecnol√≥gica:** Node.js + Express + SQLite + Vanilla JS
- **Ambiente:** Desenvolvimento/Produ√ß√£o Local
- **Status:** ‚úÖ 100% OPERACIONAL

### Respons√°veis
- **Desenvolvedor Principal:** Erik Camargo
- **Contato:** [definir email/telefone]
- **Cliente/Organiza√ß√£o:** [definir nome da organiza√ß√£o]

---

## üìä ESTADO ATUAL DO SISTEMA (v1.1.0)

### ‚úÖ Funcionalidades Implementadas e Funcionais

#### 1. **Gest√£o de Doadores**
- [x] Cadastro de doadores com valida√ß√£o ‚úÖ
- [x] C√≥digo √∫nico autom√°tico (formato: D001-ABC) ‚úÖ FUNCIONANDO
- [x] Campos pessoais: Nome, CPF, Telefone 1, Telefone 2, Email ‚úÖ
- [x] **Campos de endere√ßo completo:** CEP, Logradouro, N√∫mero, Complemento, Bairro, Cidade, Estado ‚úÖ
- [x] **Busca autom√°tica de CEP via ViaCEP API** ‚úÖ
- [x] Detec√ß√£o de duplicatas por CPF/Telefone ‚úÖ
- [x] Listagem com busca e filtros ‚úÖ
- [x] 15+ doadores ativos no sistema ‚úÖ

#### 2. **Gest√£o de Doa√ß√µes**
- [x] Registro de doa√ß√µes ‚úÖ
- [x] **Tipos de pagamento: DINHEIRO e PIX** ‚úÖ
- [x] Doa√ß√µes √∫nicas e recorrentes ‚úÖ
- [x] Vincula√ß√£o autom√°tica doador-doa√ß√£o ‚úÖ
- [x] **Edi√ß√£o completa de doa√ß√µes** ‚úÖ
- [x] **Hist√≥rico de pagamentos funcional** ‚úÖ
- [x] **Adicionar/Excluir pagamentos** ‚úÖ
- [x] Parcelas futuras para recorrentes ‚úÖ

#### 3. **Interface do Usu√°rio**
- [x] Dashboard com cards de resumo ‚úÖ
- [x] Tabela responsiva com a√ß√µes ‚úÖ
- [x] Modal de cadastro com endere√ßo completo ‚úÖ
- [x] **Modal de edi√ß√£o totalmente funcional** ‚úÖ
- [x] **Modal de hist√≥rico de pagamentos** ‚úÖ
- [x] Filtros (tipo, recorr√™ncia, busca) ‚úÖ
- [x] Indicadores visuais (badges, cores) ‚úÖ
- [x] **Indicador visual de busca CEP** (amarelo/verde/vermelho) ‚úÖ

#### 4. **Banco de Dados**
- [x] 4 tabelas principais estruturadas ‚úÖ
- [x] **14 campos na tabela doadores** (incluindo endere√ßo) ‚úÖ
- [x] √çndices √∫nicos para CPF e c√≥digo ‚úÖ
- [x] Relacionamentos com chaves estrangeiras ‚úÖ
- [x] Scripts de inicializa√ß√£o e upgrade ‚úÖ
- [x] **Fun√ß√£o checkPossibleDuplicates corrigida** ‚úÖ

#### 2. **Gest√£o de Doa√ß√µes**
- [x] Registro de doa√ß√µes (Dinheiro/Produto/Servi√ßo)
- [x] Doa√ß√µes √∫nicas e recorrentes
- [x] Vincula√ß√£o autom√°tica doador-doa√ß√£o
- [x] Hist√≥rico de pagamentos
- [x] Parcelas futuras para recorrentes

#### 3. **Interface do Usu√°rio**
- [x] Dashboard com cards de resumo
- [x] Tabela responsiva com a√ß√µes
- [x] Modal de cadastro simplificado
- [x] Filtros (tipo, recorr√™ncia, busca)
- [x] Indicadores visuais (badges, cores)

#### 4. **Banco de Dados**
- [x] 4 tabelas principais (doadores, doacoes, historico_pagamentos, parcelas_futuras)
- [x] √çndices √∫nicos para CPF e c√≥digo
- [x] Relacionamentos com chaves estrangeiras
- [x] Scripts de inicializa√ß√£o e upgrade

### ‚ö†Ô∏è Funcionalidades Parciais

#### 1. **Gr√°ficos do Dashboard**
- Estado: Placeholder implementado
- Fun√ß√£o `createCharts()` vazia
- Arquivo: `app.js`

#### 2. **Exporta√ß√£o de Dados**
- Estado: Bot√£o existe, fun√ß√£o vazia
- Fun√ß√£o `exportData()` n√£o implementada
- Arquivo: `app.js`

### üî¥ Funcionalidades N√£o Implementadas

1. **Gera√ß√£o de Carn√™ PDF** - `generateCarne()` apenas alert
2. **Autentica√ß√£o/Login** - Sistema sem controle de acesso
3. **Backup Autom√°tico** - Sem rotina de backup
4. **Relat√≥rios Avan√ßados** - Apenas resumo b√°sico
5. **Notifica√ß√µes autom√°ticas** - Sem sistema de alertas

---

## üêõ BUGS CONHECIDOS

### ‚úÖ Bugs Corrigidos (v1.1.0)
1. **[RESOLVIDO] Fun√ß√£o checkPossibleDuplicates**
   - Usava `res` sem ter no escopo
   - Fun√ß√£o n√£o fechava corretamente
   - Corrigido no server.js reescrito
   
2. **[RESOLVIDO] Campos de endere√ßo n√£o carregavam na edi√ß√£o**
   - Query SQL incompleta
   - Corrigido com todos os campos no SELECT

3. **[RESOLVIDO] ViaCEP n√£o funcionava**
   - Fun√ß√£o mal implementada
   - Corrigido com nova implementa√ß√£o

### Baixos (N√£o Cr√≠ticos)
1. **Console.logs em produ√ß√£o** - M√∫ltiplos logs de debug ativos
2. **Modal de hist√≥rico duplicado no HTML** - N√£o afeta funcionamento
3. **Valida√ß√£o de CPF** - Apenas formata√ß√£o, sem valida√ß√£o de d√≠gitos verificadores

---

## üîí SEGURAN√áA E VALIDA√á√ïES

### Implementadas
- ‚úÖ Escape b√°sico de SQL injection (parametriza√ß√£o)
- ‚úÖ Valida√ß√£o de campos obrigat√≥rios
- ‚úÖ Verifica√ß√£o de duplicatas

### Pendentes
- ‚ùå Autentica√ß√£o e autoriza√ß√£o
- ‚ùå Rate limiting
- ‚ùå HTTPS
- ‚ùå Valida√ß√£o de CPF (algoritmo)
- ‚ùå Sanitiza√ß√£o de inputs no frontend
- ‚ùå Tokens CSRF
- ‚ùå Logs de auditoria

---

## üì¶ DEPEND√äNCIAS

### Produ√ß√£o
```json
{
  "express": "^4.18.2",
  "sqlite3": "^5.1.6",
  "cors": "^2.8.5",
  "body-parser": "^1.20.2"
}
```

### Desenvolvimento
```json
{
  "nodemon": "^3.0.1"
}
```

### Frontend (CDN)
- TailwindCSS 2.2.19
- Feather Icons 4.28.0
- Chart.js 3.9.1

---

## üóÇÔ∏è ESTRUTURA DO BANCO DE DADOS

### Tabela: doadores (14 campos)
| Campo | Tipo | Constraints | Descri√ß√£o |
|-------|------|------------|-----------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID √∫nico |
| nome | TEXT | NOT NULL | Nome completo |
| email | TEXT | - | Email opcional |
| telefone1 | TEXT | NOT NULL | Telefone principal |
| telefone2 | TEXT | - | Telefone secund√°rio |
| cpf | TEXT | UNIQUE (quando n√£o nulo) | CPF sem formata√ß√£o |
| codigo_doador | TEXT | UNIQUE | C√≥digo vis√≠vel (D001-ABC) |
| **cep** | TEXT | - | CEP (00000-000) |
| **logradouro** | TEXT | - | Rua, Avenida, etc |
| **numero** | TEXT | - | N√∫mero do endere√ßo |
| **complemento** | TEXT | - | Apto, Bloco, Sala |
| **bairro** | TEXT | - | Nome do bairro |
| **cidade** | TEXT | - | Nome da cidade |
| **estado** | TEXT | - | UF (2 caracteres) |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Data de cria√ß√£o |

### Tabela: doacoes (Tipos: Dinheiro, PIX)
| Campo | Tipo | Constraints | Descri√ß√£o |
|-------|------|------------|-----------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID √∫nico |
| doador_id | INTEGER | FOREIGN KEY ‚Üí doadores.id | Refer√™ncia ao doador |
| valor | REAL | NOT NULL | Valor da doa√ß√£o |
| tipo | TEXT | NOT NULL | **Dinheiro ou PIX apenas** |
| data_doacao | TEXT | NOT NULL | Data no formato ISO |
| recorrente | INTEGER | DEFAULT 0 | 0=√∫nica, 1=recorrente |
| observacoes | TEXT | - | Notas adicionais |
| parcelas_totais | INTEGER | DEFAULT 1 | Total de parcelas |
| data_proxima_parcela | TEXT | - | Data da pr√≥xima parcela |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Data de cria√ß√£o |

### Tabela: historico_pagamentos
| Campo | Tipo | Constraints | Descri√ß√£o |
|-------|------|------------|-----------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID √∫nico |
| doacao_id | INTEGER | FOREIGN KEY ‚Üí doacoes.id | Refer√™ncia √† doa√ß√£o |
| data_pagamento | TEXT | NOT NULL | Data do pagamento |
| valor | REAL | NOT NULL | Valor pago |
| status | TEXT | DEFAULT 'Pago' | Status do pagamento |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Data de cria√ß√£o |

### Tabela: parcelas_futuras
| Campo | Tipo | Constraints | Descri√ß√£o |
|-------|------|------------|-----------|
| id | INTEGER | PRIMARY KEY, AUTOINCREMENT | ID √∫nico |
| doacao_id | INTEGER | FOREIGN KEY ‚Üí doacoes.id | Refer√™ncia √† doa√ß√£o |
| numero_parcela | INTEGER | - | N√∫mero da parcela |
| data_vencimento | TEXT | NOT NULL | Data de vencimento |
| valor | REAL | NOT NULL | Valor da parcela |
| status | TEXT | DEFAULT 'Pendente' | Status da parcela |
| created_at | DATETIME | DEFAULT CURRENT_TIMESTAMP | Data de cria√ß√£o |

---

## üìù ROADMAP DE DESENVOLVIMENTO

### Fase 1: Corre√ß√µes Urgentes (Sprint 1 - 1 semana)
- [ ] Corrigir vari√°vel truncada no app.js
- [ ] Remover duplica√ß√£o do modal de hist√≥rico
- [ ] Implementar interface de verifica√ß√£o de duplicatas
- [ ] Adicionar valida√ß√£o completa de CPF

### Fase 2: Funcionalidades Essenciais (Sprint 2-3 - 2 semanas)
- [ ] Implementar edi√ß√£o de doa√ß√µes
- [ ] Completar hist√≥rico de pagamentos
- [ ] Implementar exporta√ß√£o (CSV/Excel)
- [ ] Adicionar gr√°ficos funcionais

### Fase 3: Seguran√ßa (Sprint 4 - 1 semana)
- [ ] Sistema de autentica√ß√£o
- [ ] N√≠veis de acesso (admin/operador)
- [ ] Logs de auditoria
- [ ] Backup autom√°tico

### Fase 4: Recursos Avan√ßados (Sprint 5-6 - 2 semanas)
- [ ] Gera√ß√£o de carn√™s PDF
- [ ] Relat√≥rios personalizados
- [ ] Dashboard analytics avan√ßado
- [ ] Notifica√ß√µes de vencimento

### Fase 5: Otimiza√ß√µes (Sprint 7 - 1 semana)
- [ ] Pagina√ß√£o server-side
- [ ] Cache de consultas
- [ ] Compress√£o de assets
- [ ] PWA (offline support)

---

## üîÑ HIST√ìRICO DE VERS√ïES

### v1.1.0 (01/Setembro/2025) ‚úÖ ATUAL
**Tipo:** Minor Release - Novas Funcionalidades
**Mudan√ßas:**
- ‚úÖ Implementada edi√ß√£o completa de doa√ß√µes
- ‚úÖ Implementado hist√≥rico de pagamentos funcional
- ‚úÖ Adicionados campos de endere√ßo (7 novos campos)
- ‚úÖ Integra√ß√£o com API ViaCEP para busca autom√°tica
- ‚úÖ Tipos de pagamento simplificados: Dinheiro e PIX
- ‚úÖ Modal de hist√≥rico com adicionar/excluir pagamentos
- ‚úÖ Corre√ß√£o da fun√ß√£o checkPossibleDuplicates
- ‚úÖ server.js completamente reescrito e otimizado

**Novos Scripts Criados:**
```bash
implementar-edicao-historico.js  # Implementou edi√ß√£o e hist√≥rico
adicionar-campos-endereco.js      # Adicionou campos de endere√ßo
corrigir-viacep-edicao.js        # Corrigiu busca CEP
ajustar-edicao-endereco-tipos.js # Ajustou tipos de pagamento
```

**Estrutura do Banco Atualizada:**
- Tabela doadores: 14 campos (7 novos de endere√ßo)
- Tipos aceitos: Dinheiro e PIX apenas

**Status:** ‚úÖ SISTEMA 100% FUNCIONAL

---

### v1.0.1 (31/Agosto/2025)
**Tipo:** Corre√ß√£o Cr√≠tica (Hotfix)
**Mudan√ßas:**
- ‚úÖ Corrigido erro SQLITE_ERROR: coluna codigo_doador n√£o existia
- ‚úÖ Removida linha truncada no app.js (linha 634)
- ‚úÖ Adicionadas colunas faltantes: codigo_doador e cpf
- ‚úÖ Gerados c√≥digos autom√°ticos para 15 doadores existentes
- ‚úÖ Criados √≠ndices para otimiza√ß√£o
- ‚úÖ Criados scripts de reparo: repair.js e fix-codigo-doador.js

**Scripts de Corre√ß√£o Aplicados:**
```bash
node repair.js              # Corre√ß√£o geral do sistema
node fix-codigo-doador.js   # Corre√ß√£o espec√≠fica do banco
```

**Status:** ‚úÖ SISTEMA 100% OPERACIONAL

---

### v1.0.0 (Agosto/2025)
**Tipo:** Release Inicial
**Mudan√ßas:**
- Sistema base implementado
- CRUD de doadores e doa√ß√µes
- Interface responsiva
- Detec√ß√£o de duplicatas

**Problemas Conhecidos:**
- Modal de duplicatas incompleto
- Funcionalidades de edi√ß√£o pendentes
- Sem autentica√ß√£o

---

## üöÄ PROCEDIMENTOS DE DEPLOY

### Desenvolvimento Local
```bash
# Instalar depend√™ncias
npm install

# Inicializar banco (primeira vez)
npm run init-db

# Upgrade do banco (adicionar campos)
npm run upgrade-db

# Iniciar servidor
npm start  # Produ√ß√£o na porta 3001
npm run dev  # Dev com nodemon
```

### Produ√ß√£o
```bash
# 1. Fazer backup do banco
cp database/doacoes.db database/backup_$(date +%Y%m%d).db

# 2. Pull das altera√ß√µes
git pull origin main

# 3. Instalar/atualizar depend√™ncias
npm install --production

# 4. Aplicar migrations se houver
npm run upgrade-db

# 5. Reiniciar servidor
pm2 restart sistema-doacoes
```

---

## üîß CONFIGURA√á√ïES E VARI√ÅVEIS

### Servidor
- **Porta:** 3001 (hardcoded)
- **CORS:** Habilitado para todas origens
- **Body Limit:** Padr√£o Express (~100kb)

### Banco de Dados
- **Tipo:** SQLite3
- **Arquivo:** `./database/doacoes.db`
- **Modo:** Serializado
- **Backup:** Manual necess√°rio

### Frontend
- **API Base:** `/api` (relativo)
- **Timeout:** N√£o configurado
- **Cache:** Desabilitado

---

## üìä M√âTRICAS E MONITORAMENTO

### KPIs do Sistema
- Total de doadores cadastrados
- Total de doa√ß√µes registradas
- Valor total arrecadado
- Taxa de doa√ß√µes recorrentes
- M√©dia de valor por doa√ß√£o

### Pontos de Monitoramento Sugeridos
1. **Performance**
   - Tempo de resposta das APIs
   - Tamanho do banco de dados
   - Uso de mem√≥ria do Node.js

2. **Neg√≥cio**
   - Doa√ß√µes por per√≠odo
   - Taxa de inadimpl√™ncia
   - Doadores mais ativos

3. **Erros**
   - Falhas de valida√ß√£o
   - Tentativas de duplica√ß√£o
   - Erros de banco de dados

---

## üõ†Ô∏è SCRIPTS √öTEIS

### Backup Manual
```bash
#!/bin/bash
# backup.sh
BACKUP_DIR="./backups"
DB_FILE="./database/doacoes.db"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR
cp $DB_FILE "$BACKUP_DIR/doacoes_$TIMESTAMP.db"
echo "Backup criado: doacoes_$TIMESTAMP.db"
```

### Limpeza de Logs
```bash
# Remover console.logs em produ√ß√£o
sed -i '/console\.log/d' public/app.js
```

### Verifica√ß√£o de Integridade
```sql
-- check_integrity.sql
SELECT 'Doadores sem c√≥digo' as check_type, COUNT(*) as count 
FROM doadores WHERE codigo_doador IS NULL;

SELECT 'Doa√ß√µes √≥rf√£s' as check_type, COUNT(*) as count 
FROM doacoes WHERE doador_id NOT IN (SELECT id FROM doadores);

SELECT 'Pagamentos √≥rf√£os' as check_type, COUNT(*) as count 
FROM historico_pagamentos WHERE doacao_id NOT IN (SELECT id FROM doacoes);
```

---

## üìû SUPORTE E CONTATOS

### Desenvolvimento
- **Git Issues:** [Criar issue no GitHub](https://github.com/erikcamargo-max/sistema-doacoes-v1/issues)
- **Email:** [definir email de suporte]

### Emerg√™ncias
- **Servidor caiu:** Verificar logs em `./logs/`
- **Banco corrompido:** Restaurar √∫ltimo backup
- **Perda de dados:** Verificar backups autom√°ticos

---

## ‚úÖ CHECKLIST DE MANUTEN√á√ÉO

### Di√°rio
- [ ] Verificar logs de erro
- [ ] Monitorar espa√ßo em disco
- [ ] Conferir backups

### Semanal
- [ ] Backup completo do sistema
- [ ] An√°lise de performance
- [ ] Revis√£o de doa√ß√µes pendentes

### Mensal
- [ ] Limpeza de logs antigos
- [ ] Otimiza√ß√£o do banco (VACUUM)
- [ ] Relat√≥rio de m√©tricas
- [ ] Atualiza√ß√£o de depend√™ncias

---

## üîÆ CONSIDERA√á√ïES FUTURAS

### Escalabilidade
- Migra√ß√£o para PostgreSQL quando > 10GB
- Implementar cache Redis para > 1000 usu√°rios
- CDN para assets est√°ticos

### Integra√ß√µes Poss√≠veis
- Gateway de pagamento (PagSeguro/Stripe)
- WhatsApp API para lembretes
- Google Sheets para relat√≥rios
- Sistema cont√°bil

### Melhorias UX
- Dark mode
- Atalhos de teclado
- Tour guiado para novos usu√°rios
- Personaliza√ß√£o de campos

---

**√öltima Atualiza√ß√£o:** 01/Setembro/2025
**Pr√≥xima Revis√£o:** Setembro/2025
**Documento Vers√£o:** 1.1.0

## üìå NOTAS DA VERS√ÉO 1.1.0

### Principais Melhorias Implementadas:
- ‚úÖ **Edi√ß√£o completa** de doa√ß√µes funcionando
- ‚úÖ **Hist√≥rico de pagamentos** com interface visual
- ‚úÖ **Endere√ßos completos** com 7 novos campos
- ‚úÖ **Busca autom√°tica de CEP** via ViaCEP API
- ‚úÖ **Tipos simplificados** para Dinheiro e PIX apenas
- ‚úÖ **server.js reescrito** sem erros de sintaxe

### Estat√≠sticas do Sistema:
- üìä **15+ doadores** cadastrados
- üí≥ **2 tipos de pagamento** (Dinheiro/PIX)
- üìç **14 campos** na tabela doadores
- üîß **10+ scripts** de manuten√ß√£o criados
- ‚úÖ **100% funcional** em produ√ß√£o

### Scripts de Manuten√ß√£o Dispon√≠veis:
1. **repair.js** - Reparo geral do sistema
2. **fix-codigo-doador.js** - Corre√ß√£o de c√≥digos
3. **implementar-edicao-historico.js** - Adiciona edi√ß√£o
4. **adicionar-campos-endereco.js** - Adiciona endere√ßos
5. **corrigir-viacep-edicao.js** - Corrige busca CEP
6. **ajustar-edicao-endereco-tipos.js** - Ajusta tipos

### Comando de Backup Recomendado:
```bash
# Backup completo do sistema v1.1.0
cp database/doacoes.db backups/doacoes_v1.1.0_$(date +%Y%m%d).db
cp server.js backups/server_v1.1.0_$(date +%Y%m%d).js
cp public/app.js backups/app_v1.1.0_$(date +%Y%m%d).js
```

### Pr√≥ximas Implementa√ß√µes Sugeridas:
1. **Gr√°ficos funcionais** no dashboard
2. **Exporta√ß√£o CSV/Excel** dos dados
3. **Gera√ß√£o de carn√™s PDF**
4. **Sistema de autentica√ß√£o**
5. **Backup autom√°tico agendado**