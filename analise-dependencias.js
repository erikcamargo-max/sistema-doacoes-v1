/**
 * ================================================================
 * SCRIPT: An√°lise de Depend√™ncias para Modulariza√ß√£o
 * ================================================================
 * 
 * VERS√ÉO: 2.0.0
 * DATA: 09/09/2025
 * FASE: 2 - MODULARIZA√á√ÉO
 * ETAPA: 2.1 - An√°lise de Depend√™ncias
 * 
 * DESCRI√á√ÉO:
 * Analisa o app.js identificando todas as fun√ß√µes e suas
 * interdepend√™ncias para criar um mapa de modulariza√ß√£o seguro.
 * 
 * ================================================================
 */

const fs = require('fs');
const path = require('path');

console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
console.log('‚ïë   AN√ÅLISE DE DEPEND√äNCIAS - SISTEMA v1.2.0        ‚ïë');
console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');
console.log(`\nüìÖ Data/Hora: ${new Date().toLocaleString('pt-BR')}\n`);

// Configura√ß√µes
const APP_JS_PATH = path.join(__dirname, 'public', 'app.js');
const REPORT_PATH = path.join(__dirname, 'docs', 'dependencias_mapa.json');
const DOCS_DIR = path.join(__dirname, 'docs');

// Verificar arquivo
if (!fs.existsSync(APP_JS_PATH)) {
    console.error('‚ùå Arquivo app.js n√£o encontrado!');
    process.exit(1);
}

// Criar diret√≥rio docs se n√£o existir
if (!fs.existsSync(DOCS_DIR)) {
    fs.mkdirSync(DOCS_DIR, { recursive: true });
}

// Ler conte√∫do
const content = fs.readFileSync(APP_JS_PATH, 'utf8');
const lines = content.split('\n');

console.log(`üìÅ Analisando: ${APP_JS_PATH}`);
console.log(`üìä Total de ${lines.length} linhas\n`);

// ================================================================
// 1. IDENTIFICAR TODAS AS FUN√á√ïES
// ================================================================

console.log('1Ô∏è‚É£  Identificando fun√ß√µes...\n');

const functions = new Map();
const globalVars = new Set();
const apiCalls = new Map();

// Patterns para identificar elementos
const patterns = {
    functionDecl: /function\s+(\w+)\s*\([^)]*\)/g,
    functionExpr: /(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s+)?function/g,
    arrowFunction: /(?:const|let|var)\s+(\w+)\s*=\s*(?:async\s+)?\([^)]*\)\s*=>/g,
    globalVar: /(?:let|var)\s+(\w+)\s*=/g,
    fetchCall: /fetch\s*\(\s*['"`]([^'"`]+)['"`]/g,
    domQuery: /document\.(getElementById|querySelector|querySelectorAll)\s*\(\s*['"`]([^'"`]+)['"`]/g,
    eventListener: /addEventListener\s*\(\s*['"`](\w+)['"`]/g
};

// Coletar fun√ß√µes
let match;
while ((match = patterns.functionDecl.exec(content)) !== null) {
    const name = match[1];
    const startPos = match.index;
    const lineNum = content.substring(0, startPos).split('\n').length;
    
    functions.set(name, {
        name: name,
        type: 'function',
        line: lineNum,
        calls: [],
        calledBy: [],
        domAccess: [],
        apiCalls: [],
        category: null
    });
}

// Fun√ß√µes const/let/var
patterns.functionExpr.lastIndex = 0;
while ((match = patterns.functionExpr.exec(content)) !== null) {
    const name = match[1];
    const startPos = match.index;
    const lineNum = content.substring(0, startPos).split('\n').length;
    
    if (!functions.has(name)) {
        functions.set(name, {
            name: name,
            type: 'const/let',
            line: lineNum,
            calls: [],
            calledBy: [],
            domAccess: [],
            apiCalls: [],
            category: null
        });
    }
}

// Arrow functions
patterns.arrowFunction.lastIndex = 0;
while ((match = patterns.arrowFunction.exec(content)) !== null) {
    const name = match[1];
    const startPos = match.index;
    const lineNum = content.substring(0, startPos).split('\n').length;
    
    if (!functions.has(name)) {
        functions.set(name, {
            name: name,
            type: 'arrow',
            line: lineNum,
            calls: [],
            calledBy: [],
            domAccess: [],
            apiCalls: [],
            category: null
        });
    }
}

console.log(`‚úÖ ${functions.size} fun√ß√µes identificadas`);

// ================================================================
// 2. ANALISAR DEPEND√äNCIAS
// ================================================================

console.log('\n2Ô∏è‚É£  Analisando depend√™ncias entre fun√ß√µes...\n');

// Para cada fun√ß√£o, identificar o que ela chama
functions.forEach((funcData, funcName) => {
    // Encontrar o corpo da fun√ß√£o
    const funcRegex = new RegExp(`(function\\s+${funcName}|${funcName}\\s*=)[^{]*{([^}]+function[^}]+)*[^}]+}`, 'gs');
    const funcMatch = funcRegex.exec(content);
    
    if (funcMatch) {
        const funcBody = funcMatch[0];
        
        // Verificar chamadas a outras fun√ß√µes
        functions.forEach((_, otherFunc) => {
            if (otherFunc !== funcName) {
                const callRegex = new RegExp(`\\b${otherFunc}\\s*\\(`, 'g');
                if (callRegex.test(funcBody)) {
                    funcData.calls.push(otherFunc);
                    functions.get(otherFunc).calledBy.push(funcName);
                }
            }
        });
        
        // Verificar chamadas de API
        patterns.fetchCall.lastIndex = 0;
        let apiMatch;
        while ((apiMatch = patterns.fetchCall.exec(funcBody)) !== null) {
            funcData.apiCalls.push(apiMatch[1]);
        }
        
        // Verificar acesso ao DOM
        patterns.domQuery.lastIndex = 0;
        let domMatch;
        while ((domMatch = patterns.domQuery.exec(funcBody)) !== null) {
            funcData.domAccess.push({
                method: domMatch[1],
                selector: domMatch[2]
            });
        }
    }
});

// ================================================================
// 3. CATEGORIZAR FUN√á√ïES
// ================================================================

console.log('3Ô∏è‚É£  Categorizando fun√ß√µes por responsabilidade...\n');

functions.forEach((func) => {
    const name = func.name.toLowerCase();
    
    // Categoriza√ß√£o baseada no nome e chamadas de API
    if (name.includes('load') || name.includes('fetch') || name.includes('get')) {
        func.category = 'api';
    } else if (name.includes('modal') || name.includes('open') || name.includes('close') || name.includes('show') || name.includes('hide')) {
        func.category = 'modals';
    } else if (name.includes('donor') || name.includes('doador')) {
        func.category = 'doadores';
    } else if (name.includes('donation') || name.includes('doacao')) {
        func.category = 'doacoes';
    } else if (name.includes('history') || name.includes('historico') || name.includes('payment')) {
        func.category = 'historico';
    } else if (name.includes('filter') || name.includes('search') || name.includes('busca')) {
        func.category = 'filters';
    } else if (name.includes('export') || name.includes('pdf') || name.includes('carne')) {
        func.category = 'exports';
    } else if (name.includes('format') || name.includes('validate') || name.includes('calc')) {
        func.category = 'utils';
    } else if (func.apiCalls.length > 0) {
        func.category = 'api';
    } else if (func.domAccess.length > 2) {
        func.category = 'modals';
    } else {
        func.category = 'utils';
    }
});

// Contar por categoria
const categories = {};
functions.forEach(func => {
    if (!categories[func.category]) {
        categories[func.category] = [];
    }
    categories[func.category].push(func.name);
});

console.log('üìä Distribui√ß√£o por categoria:');
Object.entries(categories).forEach(([cat, funcs]) => {
    console.log(`   ${cat}: ${funcs.length} fun√ß√µes`);
});

// ================================================================
// 4. IDENTIFICAR VARI√ÅVEIS GLOBAIS
// ================================================================

console.log('\n4Ô∏è‚É£  Identificando vari√°veis globais...\n');

patterns.globalVar.lastIndex = 0;
while ((match = patterns.globalVar.exec(content)) !== null) {
    // Verificar se est√° no escopo global (n√£o dentro de fun√ß√£o)
    const beforeMatch = content.substring(0, match.index);
    const openBraces = (beforeMatch.match(/{/g) || []).length;
    const closeBraces = (beforeMatch.match(/}/g) || []).length;
    
    if (openBraces === closeBraces) {
        globalVars.add(match[1]);
    }
}

console.log(`üì¶ ${globalVars.size} vari√°veis globais identificadas`);

// ================================================================
// 5. CRIAR PLANO DE MODULARIZA√á√ÉO
// ================================================================

console.log('\n5Ô∏è‚É£  Criando plano de modulariza√ß√£o...\n');

const modules = {
    'config.js': {
        description: 'Configura√ß√µes e constantes globais',
        functions: [],
        globals: Array.from(globalVars).filter(v => v.includes('URL') || v.includes('CONFIG')),
        estimatedLines: 50
    },
    'api.js': {
        description: 'Chamadas √† API e comunica√ß√£o com backend',
        functions: categories.api || [],
        globals: [],
        estimatedLines: 300
    },
    'doadores.js': {
        description: 'Gest√£o de doadores',
        functions: categories.doadores || [],
        globals: ['allDonors'],
        estimatedLines: 400
    },
    'doacoes.js': {
        description: 'Gest√£o de doa√ß√µes',
        functions: categories.doacoes || [],
        globals: ['allDonations', 'currentDonationId'],
        estimatedLines: 600
    },
    'historico.js': {
        description: 'Hist√≥rico de pagamentos',
        functions: categories.historico || [],
        globals: [],
        estimatedLines: 300
    },
    'modals.js': {
        description: 'Gerenciamento de modais',
        functions: categories.modals || [],
        globals: ['currentEditingId', 'duplicateCheckModal'],
        estimatedLines: 500
    },
    'filters.js': {
        description: 'Sistema de filtros e busca',
        functions: categories.filters || [],
        globals: [],
        estimatedLines: 200
    },
    'exports.js': {
        description: 'Exporta√ß√£o e gera√ß√£o de documentos',
        functions: categories.exports || [],
        globals: [],
        estimatedLines: 400
    },
    'utils.js': {
        description: 'Fun√ß√µes utilit√°rias',
        functions: categories.utils || [],
        globals: [],
        estimatedLines: 150
    },
    'init.js': {
        description: 'Inicializa√ß√£o do sistema',
        functions: ['DOMContentLoaded', 'setupEventListeners'],
        globals: [],
        estimatedLines: 100
    }
};

// ================================================================
// 6. AN√ÅLISE DE COMPLEXIDADE
// ================================================================

console.log('6Ô∏è‚É£  An√°lise de complexidade das depend√™ncias...\n');

// Identificar fun√ß√µes com muitas depend√™ncias (complexas)
const complexFunctions = [];
functions.forEach(func => {
    const complexity = func.calls.length + func.calledBy.length;
    if (complexity > 5) {
        complexFunctions.push({
            name: func.name,
            complexity: complexity,
            calls: func.calls.length,
            calledBy: func.calledBy.length
        });
    }
});

if (complexFunctions.length > 0) {
    console.log('‚ö†Ô∏è  Fun√ß√µes complexas (muitas depend√™ncias):');
    complexFunctions
        .sort((a, b) => b.complexity - a.complexity)
        .slice(0, 5)
        .forEach(func => {
            console.log(`   - ${func.name}: ${func.complexity} conex√µes (chama ${func.calls}, chamada por ${func.calledBy})`);
        });
}

// ================================================================
// 7. GERAR RELAT√ìRIO
// ================================================================

console.log('\n7Ô∏è‚É£  Gerando relat√≥rio de depend√™ncias...\n');

const report = {
    timestamp: new Date().toISOString(),
    statistics: {
        totalLines: lines.length,
        totalFunctions: functions.size,
        totalGlobals: globalVars.size,
        categories: Object.keys(categories).length
    },
    modules: modules,
    dependencies: Object.fromEntries(functions),
    globalVariables: Array.from(globalVars),
    complexFunctions: complexFunctions,
    recommendations: []
};

// Adicionar recomenda√ß√µes
if (complexFunctions.length > 10) {
    report.recommendations.push('‚ö†Ô∏è Muitas fun√ß√µes complexas - considere refatora√ß√£o adicional');
}

if (globalVars.size > 20) {
    report.recommendations.push('‚ö†Ô∏è Muitas vari√°veis globais - agrupe em objetos de configura√ß√£o');
}

report.recommendations.push('‚úÖ Estrutura modular proposta com 10 arquivos');
report.recommendations.push('‚úÖ Estimativa de redu√ß√£o: 3041 ‚Üí ~300 linhas por m√≥dulo');

// Salvar relat√≥rio
fs.writeFileSync(REPORT_PATH, JSON.stringify(report, null, 2));

// ================================================================
// RELAT√ìRIO FINAL
// ================================================================

console.log('‚ïê'.repeat(56));
console.log('üìä RELAT√ìRIO DE AN√ÅLISE:');
console.log('‚ïê'.repeat(56));
console.log(`üìù Fun√ß√µes analisadas: ${functions.size}`);
console.log(`üì¶ Vari√°veis globais: ${globalVars.size}`);
console.log(`üìÅ M√≥dulos propostos: ${Object.keys(modules).length}`);
console.log(`\nüìä DISTRIBUI√á√ÉO PROPOSTA:`);

let totalEstimated = 0;
Object.entries(modules).forEach(([file, data]) => {
    console.log(`\n   ${file} (~${data.estimatedLines} linhas)`);
    console.log(`   ‚îî‚îÄ ${data.functions.length} fun√ß√µes`);
    totalEstimated += data.estimatedLines;
});

console.log(`\nüìâ REDU√á√ÉO ESPERADA:`);
console.log(`   De: ${lines.length} linhas (arquivo √∫nico)`);
console.log(`   Para: ~${totalEstimated} linhas (distribu√≠das)`);
console.log(`   M√©dia: ~${Math.round(totalEstimated / Object.keys(modules).length)} linhas por m√≥dulo`);

console.log('\nüìã PR√ìXIMOS PASSOS:');
console.log('‚ïê'.repeat(56));
console.log('1. Revisar o relat√≥rio em: docs/dependencias_mapa.json');
console.log('2. Executar: "criar-estrutura-modular.js"');
console.log('3. Executar: "modularizar-app.js"');

console.log('\n‚úÖ AN√ÅLISE CONCLU√çDA!');
console.log(`üìÑ Relat√≥rio salvo em: ${REPORT_PATH}`);
console.log('‚ïê'.repeat(56));